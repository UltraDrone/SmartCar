C251 COMPILER V5.60.0,  SEEKFREE_IMU963RA                                                  06/07/24  23:05:05  PAGE 1   


C251 COMPILER V5.60.0, COMPILATION OF MODULE SEEKFREE_IMU963RA
OBJECT MODULE PLACED IN .\Out_File\SEEKFREE_IMU963RA.obj
COMPILER INVOKED BY: G:\Keil_v5\C251\C251\BIN\C251.EXE ..\..\Libraries\seekfree_peripheral\SEEKFREE_IMU963RA.c XSMALL IN
                    -TR2 WARNINGLEVEL(3) OPTIMIZE(0,SPEED) BROWSE INCDIR(..\..\Libraries\libraries;..\..\Libraries\seekfree_libraries;..\..\L
                    -ibraries\seekfree_peripheral;..\CODE;..\USER\inc;..\USER\src;..\CODE) DEBUG PRINT(.\Out_File\SEEKFREE_IMU963RA.lst) OBJE
                    -CT(.\Out_File\SEEKFREE_IMU963RA.obj) 

stmt  level    source

    1          /********************************************************************************************************
             -*************
    2           * COPYRIGHT NOTICE
    3           * Copyright (c) 2018,é€é£ç§‘æŠ€
    4           * All rights reserved.
    5           * æŠ€æœ¯è®¨è®ºQQç¾¤ï¼šä¸€ç¾¤ï¼š179029047(å·²æ»¡)  äºŒç¾¤ï¼š244861897
    6           *
    7           * ä»¥ä¸‹æ‰€æœ‰å†…å®¹ç‰ˆæƒå‡å±é€é£ç§‘æŠ€æ‰€æœ‰ï¼Œæœªç»å…è®¸ä¸å¾—ç”¨äºå•†ä¸šç”¨é€”ï¼Œ
    8           * æ¬¢è¿å„ä½ä½¿ç”¨å¹¶ä¼ æ’­æœ¬ç¨‹åºï¼Œä¿®æ”¹å†…å®¹æ—¶å¿…é¡»ä¿ç•™é€é£ç§‘æŠ€çš„ç‰ˆæƒå£°æ˜ã€‚
    9           *
   10           * @file                IMU963RA
   11           * @company                     æˆéƒ½é€é£ç§‘æŠ€æœ‰é™å…¬å¸
   12           * @author              é€é£ç§‘æŠ€(QQ3184284598)
   13           * @version             æŸ¥çœ‹docå†…versionæ–‡ä»¶ ç‰ˆæœ¬è¯´æ˜
   14           * @Software            MDK FOR C251 V5.60
   15           * @Target core         STC32G12K128
   16           * @Taobao              https://seekfree.taobao.com/
   17           * @date                2019-04-30
   18           * @note
   19           * æ¥çº¿å®šä¹‰ï¼š
   20           *                   ------------------------------------
   21           *                   æ¨¡å—ç®¡è„š            å•ç‰‡æœºç®¡è„š
   22           *                   // ç¡¬ä»¶ SPI å¼•è„š
   23           *                   SCL/SPC             æŸ¥çœ‹ SEEKFREE_IMU963RA.h ä¸­ IMU963RA_SPC_PIN å®å®šä¹‰
   24           *                   SDA/DSI             æŸ¥çœ‹ SEEKFREE_IMU963RA.h ä¸­ IMU963RA_SDI_PIN å®å®šä¹‰
   25           *                   SA0/SDO             æŸ¥çœ‹ SEEKFREE_IMU963RA.h ä¸­ IMU963RA_SDO_PIN å®å®šä¹‰
   26           *                   CS                  æŸ¥çœ‹ SEEKFREE_IMU963RA.h ä¸­ IMU963RA_CS_PIN  å®å®šä¹‰
   27           *                   VCC                 3.3Vç”µæº
   28           *                   GND                 ç”µæºåœ°
   29           *                   å…¶ä½™å¼•è„šæ‚¬ç©º
   30           *
   31           *                   // è½¯ä»¶ IIC å¼•è„š
   32           *                   SCL/SPC             æŸ¥çœ‹ SEEKFREE_IMU963RA.h ä¸­ IMU963RA_SCL_PIN å®å®šä¹‰
   33           *                   SDA/DSI             æŸ¥çœ‹ SEEKFREE_IMU963RA.h ä¸­ IMU963RA_SDA_PIN å®å®šä¹‰
   34           *                   VCC                 3.3Vç”µæº
   35           *                   GND                 ç”µæºåœ°
   36           *                   å…¶ä½™å¼•è„šæ‚¬ç©º
   37           *                   ------------------------------------
   38          *********************************************************************************************************
             -***********/
   39          
   40          #include "SEEKFREE_IMU963RA.h"
   41          
   42          #include "zf_delay.h"
   43          #include "zf_spi.h"
   44          
   45          
   46          
   47          #pragma warning disable = 177
   48          #pragma warning disable = 183
   49          
   50          
   51          int16 imu963ra_gyro_x = 0, imu963ra_gyro_y = 0, imu963ra_gyro_z = 0;
   52          int16 imu963ra_acc_x = 0,  imu963ra_acc_y = 0,  imu963ra_acc_z = 0;
   53          int16 imu963ra_mag_x = 0,  imu963ra_mag_y = 0,  imu963ra_mag_z = 0;
   54          
C251 COMPILER V5.60.0,  SEEKFREE_IMU963RA                                                  06/07/24  23:05:05  PAGE 2   

   55          #if IMU963RA_USE_SOFT_IIC
               
               
               #define GET_IMU963RA_SDA                        IMU963RA_SDA_PIN
               #define IMU963RA_SDA_LOW()              IMU963RA_SDA_PIN = 0            //IOå£è¾“å‡ºä½ç”µå¹³
               #define IMU963RA_SDA_HIGH()         IMU963RA_SDA_PIN = 1                //IOå£è¾“å‡ºé«˜ç”µå¹³
               
               #define IMU963RA_SCL_LOW()          IMU963RA_SCL_PIN = 0                //IOå£è¾“å‡ºä½ç”µå¹³
               #define IMU963RA_SCL_HIGH()         IMU963RA_SCL_PIN = 1                //IOå£è¾“å‡ºé«˜ç”µå¹³
               
               #define ack 1      //ä¸»åº”ç­”
               #define no_ack 0   //ä»åº”ç­”  
               
               //-------------------------------------------------------------------------------------------------------
             -------------
               //  @brief      æ¨¡æ‹ŸIICå»¶æ—¶
               //  @return     void
               //  @since      v1.0
               //  Sample usage:                               å¦‚æœIICé€šè®¯å¤±è´¥å¯ä»¥å°è¯•å¢åŠ jçš„å€¼
               //-------------------------------------------------------------------------------------------------------
             -------------
               static void imu963ra_simiic_delay(void)
               {
                   uint16 j = IMU963RA_SOFT_IIC_DELAY;
               
                   while(j--);
               }
               
               //å†…éƒ¨ä½¿ç”¨ï¼Œç”¨æˆ·æ— éœ€è°ƒç”¨
               static void imu963ra_simiic_start(void)
               {
                   IMU963RA_SDA_HIGH();
                   IMU963RA_SCL_HIGH();
                   imu963ra_simiic_delay();
                   IMU963RA_SDA_LOW();
                   imu963ra_simiic_delay();
                   IMU963RA_SCL_LOW();
               }
               
               //å†…éƒ¨ä½¿ç”¨ï¼Œç”¨æˆ·æ— éœ€è°ƒç”¨
               static void imu963ra_simiic_stop(void)
               {
                   IMU963RA_SDA_LOW();
                   IMU963RA_SCL_LOW();
                   imu963ra_simiic_delay();
                   IMU963RA_SCL_HIGH();
                   imu963ra_simiic_delay();
                   IMU963RA_SDA_HIGH();
                   imu963ra_simiic_delay();
               }
               
               //ä¸»åº”ç­”(åŒ…å«ack:SDA=0å’Œno_ack:SDA=0)
               //å†…éƒ¨ä½¿ç”¨ï¼Œç”¨æˆ·æ— éœ€è°ƒç”¨
               static void imu963ra_simiic_sendack(unsigned char ack_dat)
               {
                   IMU963RA_SCL_LOW();
                   imu963ra_simiic_delay();
               
                   if(ack_dat) IMU963RA_SDA_LOW();
                   else        IMU963RA_SDA_HIGH();
               
                   IMU963RA_SCL_HIGH();
                   imu963ra_simiic_delay();
                   IMU963RA_SCL_LOW();
                   imu963ra_simiic_delay();
               }
C251 COMPILER V5.60.0,  SEEKFREE_IMU963RA                                                  06/07/24  23:05:05  PAGE 3   

               
               
               static int imu963ra_sccb_waitack(void)
               {
                   IMU963RA_SCL_LOW();
               
                   imu963ra_simiic_delay();
               
                   IMU963RA_SCL_HIGH();
                   imu963ra_simiic_delay();
               
                   if(GET_IMU963RA_SDA)           //åº”ç­”ä¸ºé«˜ç”µå¹³ï¼Œå¼‚å¸¸ï¼Œé€šä¿¡å¤±è´¥
                   {
               
                       IMU963RA_SCL_LOW();
                       return 0;
                   }
               
                   IMU963RA_SCL_LOW();
                   imu963ra_simiic_delay();
                   return 1;
               }
               
               //å­—èŠ‚å‘é€ç¨‹åº
               //å‘é€c(å¯ä»¥æ˜¯æ•°æ®ä¹Ÿå¯æ˜¯åœ°å€)ï¼Œé€å®Œåæ¥æ”¶ä»åº”ç­”
               //ä¸è€ƒè™‘ä»åº”ç­”ä½
               //å†…éƒ¨ä½¿ç”¨ï¼Œç”¨æˆ·æ— éœ€è°ƒç”¨
               static void imu963ra_send_ch(uint8 c)
               {
                   uint8 i = 8;
               
                   while(i--)
                   {
                       if(c & 0x80)    IMU963RA_SDA_HIGH();//SDA è¾“å‡ºæ•°æ®
                       else                    IMU963RA_SDA_LOW();
               
                       c <<= 1;
                       imu963ra_simiic_delay();
                       IMU963RA_SCL_HIGH();                //SCL æ‹‰é«˜ï¼Œé‡‡é›†ä¿¡å·
                       imu963ra_simiic_delay();
                       IMU963RA_SCL_LOW();                //SCL æ—¶é’Ÿçº¿æ‹‰ä½
                   }
               
                   imu963ra_sccb_waitack();
               }
               
               
               //å­—èŠ‚æ¥æ”¶ç¨‹åº
               //æ¥æ”¶å™¨ä»¶ä¼ æ¥çš„æ•°æ®ï¼Œæ­¤ç¨‹åºåº”é…åˆ|ä¸»åº”ç­”å‡½æ•°|ä½¿ç”¨
               //å†…éƒ¨ä½¿ç”¨ï¼Œç”¨æˆ·æ— éœ€è°ƒç”¨
               static uint8 imu963ra_read_ch(uint8 ack_x)
               {
                   uint8 i;
                   uint8 c;
                   c = 0;
                   IMU963RA_SCL_LOW();
                   imu963ra_simiic_delay();
                   IMU963RA_SDA_HIGH();
               
                   for(i = 0; i < 8; i++)
                   {
                       imu963ra_simiic_delay();
                       IMU963RA_SCL_LOW();         //ç½®æ—¶é’Ÿçº¿ä¸ºä½ï¼Œå‡†å¤‡æ¥æ”¶æ•°æ®ä½
                       imu963ra_simiic_delay();
                       IMU963RA_SCL_HIGH();         //ç½®æ—¶é’Ÿçº¿ä¸ºé«˜ï¼Œä½¿æ•°æ®çº¿ä¸Šæ•°æ®æœ‰æ•ˆ
                       imu963ra_simiic_delay();
C251 COMPILER V5.60.0,  SEEKFREE_IMU963RA                                                  06/07/24  23:05:05  PAGE 4   

                       c <<= 1;
               
                       if(GET_IMU963RA_SDA)
                       {
                           c += 1; //è¯»æ•°æ®ä½ï¼Œå°†æ¥æ”¶çš„æ•°æ®å­˜c
                       }
                   }
               
                   IMU963RA_SCL_LOW();
                   imu963ra_simiic_delay();
                   imu963ra_simiic_sendack(ack_x);
               
                   return c;
               }
               
               
               //-------------------------------------------------------------------------------------------------------
             -------------
               //  @brief      æ¨¡æ‹ŸIICå†™æ•°æ®åˆ°è®¾å¤‡å¯„å­˜å™¨å‡½æ•°
               //  @param      dev_add                 è®¾å¤‡åœ°å€(ä½ä¸ƒä½åœ°å€)
               //  @param      reg                             å¯„å­˜å™¨åœ°å€
               //  @param      dat                             å†™å…¥çš„æ•°æ®
               //  @return     void
               //  @since      v1.0
               //  Sample usage:
               //-------------------------------------------------------------------------------------------------------
             -------------
               static void imu963ra_simiic_write_reg(uint8 dev_add, uint8 reg, uint8 dat)
               {
                   imu963ra_simiic_start();
                   imu963ra_send_ch( (dev_add << 1) | 0x00); //å‘é€å™¨ä»¶åœ°å€åŠ å†™ä½
                   imu963ra_send_ch( reg );                             //å‘é€ä»æœºå¯„å­˜å™¨åœ°å€
                   imu963ra_send_ch( dat );                             //å‘é€éœ€è¦å†™å…¥çš„æ•°æ®
                   imu963ra_simiic_stop();
               }
               
               
               
               
               //-------------------------------------------------------------------------------------------------------
             -------------
               //  @brief      æ¨¡æ‹ŸIICä»è®¾å¤‡å¯„å­˜å™¨è¯»å–æ•°æ®
               //  @param      dev_add                 è®¾å¤‡åœ°å€(ä½ä¸ƒä½åœ°å€)
               //  @param      reg                             å¯„å­˜å™¨åœ°å€
               //  @param      type                    é€‰æ‹©é€šä¿¡æ–¹å¼æ˜¯IIC  è¿˜æ˜¯ SCCB
               //  @return     uint8                   è¿”å›å¯„å­˜å™¨çš„æ•°æ®
               //  @since      v1.0
               //  Sample usage:
               //-------------------------------------------------------------------------------------------------------
             -------------
               //static uint8 imu963ra_simiic_read_reg(uint8 dev_add, uint8 reg)
               //{
               //      uint8 dat;
               //      imu963ra_simiic_start();
               //    imu963ra_send_ch( (dev_add<<1) | 0x00);  //å‘é€å™¨ä»¶åœ°å€åŠ å†™ä½
               //      imu963ra_send_ch( reg );                                //å‘é€ä»æœºå¯„å­˜å™¨åœ°å€
               
               //
               //      imu963ra_simiic_start();
               //      imu963ra_send_ch( (dev_add<<1) | 0x01);  //å‘é€å™¨ä»¶åœ°å€åŠ è¯»ä½
               //      dat = imu963ra_read_ch(no_ack);                                 //è¯»å–æ•°æ®
               //      imu963ra_simiic_stop();
               //
               //      return dat;
               //}
               
C251 COMPILER V5.60.0,  SEEKFREE_IMU963RA                                                  06/07/24  23:05:05  PAGE 5   

               
               //-------------------------------------------------------------------------------------------------------
             -------------
               //  @brief      æ¨¡æ‹ŸIICä»è®¾å¤‡å¯„å­˜å™¨è¯»å–æ•°æ®
               //  @param      dev_add                 è®¾å¤‡åœ°å€(ä½ä¸ƒä½åœ°å€)
               //  @param      reg                             å¯„å­˜å™¨åœ°å€
               //  @return     uint8                   è¿”å›å¯„å­˜å™¨çš„æ•°æ®
               //  @since      v1.0
               //  Sample usage:
               //-------------------------------------------------------------------------------------------------------
             -------------
               static uint8 imu963ra_simiic_sccb_read_reg(uint8 dev_add, uint8 reg)
               {
                   uint8 dat;
                   imu963ra_simiic_start();
                   imu963ra_send_ch( (dev_add << 1) | 0x00); //å‘é€å™¨ä»¶åœ°å€åŠ å†™ä½
                   imu963ra_send_ch( reg );                            //å‘é€ä»æœºå¯„å­˜å™¨åœ°å€
                   imu963ra_simiic_stop();
               
                   imu963ra_simiic_start();
                   imu963ra_send_ch( (dev_add << 1) | 0x01); //å‘é€å™¨ä»¶åœ°å€åŠ è¯»ä½
                   dat = imu963ra_read_ch(no_ack);                             //è¯»å–æ•°æ®
                   imu963ra_simiic_stop();
               
                   return dat;
               }
               
               
               //-------------------------------------------------------------------------------------------------------
             -------------
               //  @brief      æ¨¡æ‹ŸIICè¯»å–å¤šå­—èŠ‚æ•°æ®
               //  @param      dev_add                 è®¾å¤‡åœ°å€(ä½ä¸ƒä½åœ°å€)
               //  @param      reg                             å¯„å­˜å™¨åœ°å€
               //  @param      dat_add                 æ•°æ®ä¿å­˜çš„åœ°å€æŒ‡é’ˆ
               //  @param      num                             è¯»å–å­—èŠ‚æ•°é‡
               //  @param      type                    é€‰æ‹©é€šä¿¡æ–¹å¼æ˜¯IIC  è¿˜æ˜¯ SCCB
               //  @return     uint8                   è¿”å›å¯„å­˜å™¨çš„æ•°æ®
               //  @since      v1.0
               //  Sample usage:
               //-------------------------------------------------------------------------------------------------------
             -------------
               static void imu963ra_simiic_read_regs(uint8 dev_add, uint8 reg, uint8 *dat_add, uint32 num)
               {
                   imu963ra_simiic_start();
                   imu963ra_send_ch( (dev_add << 1) | 0x00); //å‘é€å™¨ä»¶åœ°å€åŠ å†™ä½
                   imu963ra_send_ch( reg );                            //å‘é€ä»æœºå¯„å­˜å™¨åœ°å€
               
               
                   imu963ra_simiic_start();
                   imu963ra_send_ch( (dev_add << 1) | 0x01); //å‘é€å™¨ä»¶åœ°å€åŠ è¯»ä½
               
                   while(--num)
                   {
                       *dat_add = imu963ra_read_ch(ack); //è¯»å–æ•°æ®
                       dat_add++;
                   }
               
                   *dat_add = imu963ra_read_ch(no_ack); //è¯»å–æ•°æ®
                   imu963ra_simiic_stop();
               }
               
               
               //-------------------------------------------------------------------------------------------------------
             -------------
               // å‡½æ•°ç®€ä»‹     IMU963RA å†™å¯„å­˜å™¨
               // å‚æ•°è¯´æ˜     reg             å¯„å­˜å™¨åœ°å€
C251 COMPILER V5.60.0,  SEEKFREE_IMU963RA                                                  06/07/24  23:05:05  PAGE 6   

               // å‚æ•°è¯´æ˜     dat            æ•°æ®
               // è¿”å›å‚æ•°     void
               // ä½¿ç”¨ç¤ºä¾‹     imu963ra_write_acc_gyro_register(IMU963RA_SLV0_CONFIG, 0x00);
               // å¤‡æ³¨ä¿¡æ¯     å†…éƒ¨è°ƒç”¨
               //-------------------------------------------------------------------------------------------------------
             -------------
               #define imu963ra_write_acc_gyro_register(reg,dat)       (imu963ra_simiic_write_reg(IMU963RA_DEV_ADDR,reg,
             -dat))
               
               //-------------------------------------------------------------------------------------------------------
             -------------
               // å‡½æ•°ç®€ä»‹     IMU963RA è¯»å¯„å­˜å™¨
               // å‚æ•°è¯´æ˜     reg             å¯„å­˜å™¨åœ°å€
               // è¿”å›å‚æ•°     uint8           æ•°æ®
               // ä½¿ç”¨ç¤ºä¾‹     imu963ra_read_acc_gyro_register(IMU963RA_STATUS_MASTER);
               // å¤‡æ³¨ä¿¡æ¯     å†…éƒ¨è°ƒç”¨
               //-------------------------------------------------------------------------------------------------------
             -------------
               #define imu963ra_read_acc_gyro_register(reg)             (imu963ra_simiic_sccb_read_reg(IMU963RA_DEV_ADDR
             -,reg))
               
               //-------------------------------------------------------------------------------------------------------
             -------------
               // å‡½æ•°ç®€ä»‹     IMU963RA è¯»æ•°æ® å†…éƒ¨è°ƒç”¨
               // å‚æ•°è¯´æ˜     reg             å¯„å­˜å™¨åœ°å€
               // å‚æ•°è¯´æ˜     dat            æ•°æ®ç¼“å†²åŒº
               // å‚æ•°è¯´æ˜     len             æ•°æ®é•¿åº¦
               // è¿”å›å‚æ•°     void
               // ä½¿ç”¨ç¤ºä¾‹     imu963ra_read_acc_gyro_registers(IMU963RA_OUTX_L_A, dat, 6);
               // å¤‡æ³¨ä¿¡æ¯     å†…éƒ¨è°ƒç”¨
               //-------------------------------------------------------------------------------------------------------
             -------------
               #define imu963ra_read_acc_gyro_registers(reg,dat,len)   (imu963ra_simiic_read_regs(IMU963RA_DEV_ADDR,reg,
             -dat,len))
               
               
               #else
  337          
  338          
  339          
  340          #define IMU963RA_SCK(x)                         IMU963RA_SPC_PIN  = x
  341          #define IMU963RA_MOSI(x)                        IMU963RA_SDI_PIN = x
  342          #define IMU963RA_CS(x)                          IMU963RA_CS_PIN  = x
  343          #define IMU963RA_MISO                           IMU963RA_SDO_PIN
  344          
  345          //-------------------------------------------------------------------------------------------------------
             -------------
  346          //  @brief      é€šè¿‡SPIå†™ä¸€ä¸ªbyte,åŒæ—¶è¯»å–ä¸€ä¸ªbyte
  347          //  @param      byte        å‘é€çš„æ•°æ®
  348          //  @return     uint8       return è¿”å›statusçŠ¶æ€
  349          //  @since      v1.0
  350          //  Sample usage:
  351          //-------------------------------------------------------------------------------------------------------
             -------------
  352          static uint8 imu963ra_simspi_wr_byte(uint8 byte)
  353          {
  354   1          uint8 i;
  355   1      
  356   1          for(i = 0; i < 8; i++)
  357   1          {
  358   2              IMU963RA_MOSI(byte & 0x80);
  359   2              byte <<= 1;
  360   2              IMU963RA_SCK (0);
  361   2              IMU963RA_SCK (0);
  362   2      
  363   2              IMU963RA_SCK (1);
C251 COMPILER V5.60.0,  SEEKFREE_IMU963RA                                                  06/07/24  23:05:05  PAGE 7   

  364   2              IMU963RA_SCK (1);
  365   2              byte |= IMU963RA_MISO;
  366   2          }
  367   1      
  368   1          return(byte);
  369   1      }
  370          //-------------------------------------------------------------------------------------------------------
             -------------
  371          //  @brief      å°†valå†™å…¥cmdå¯¹åº”çš„å¯„å­˜å™¨åœ°å€,åŒæ—¶è¿”å›statuså­—èŠ‚
  372          //  @param      cmd         å‘½ä»¤å­—
  373          //  @param      val         å¾…å†™å…¥å¯„å­˜å™¨çš„æ•°å€¼
  374          //  @since      v1.0
  375          //  Sample usage:
  376          //-------------------------------------------------------------------------------------------------------
             -------------
  377          static void imu963ra_simspi_w_reg_byte(uint8 cmd, uint8 val)
  378          {
  379   1          IMU963RA_CS(0);
  380   1          cmd |= IMU963RA_SPI_W;
  381   1          imu963ra_simspi_wr_byte(cmd);
  382   1          imu963ra_simspi_wr_byte(val);
  383   1          IMU963RA_CS(1);
  384   1      }
  385          
  386          
  387          //-------------------------------------------------------------------------------------------------------
             -------------
  388          //  @brief      å°†valå†™å…¥cmdå¯¹åº”çš„å¯„å­˜å™¨åœ°å€
  389          //  @param      cmd         å‘½ä»¤å­—
  390          //  @param      val         å¾…å†™å…¥å¯„å­˜å™¨çš„æ•°å€¼
  391          //  @since      v1.0
  392          //  Sample usage:
  393          //-------------------------------------------------------------------------------------------------------
             -------------
  394          //static void imu963ra_simspi_w_reg_bytes(uint8 cmd, uint8 *dat_addr, uint32 len)
  395          //{
  396          
  397          //
  398          //    IMU963RA_CS(0);
  399          //    cmd |= IMU963RA_SPI_W;
  400          //    imu963ra_simspi_wr_byte(cmd);
  401          //      while(len--)
  402          //      {
  403          //              imu963ra_simspi_wr_byte(*dat_addr++);
  404          //      }
  405          //    IMU963RA_CS(1);
  406          //}
  407          
  408          //-------------------------------------------------------------------------------------------------------
             -------------
  409          //  @brief      è¯»å–cmdæ‰€å¯¹åº”çš„å¯„å­˜å™¨åœ°å€
  410          //  @param      cmd         å‘½ä»¤å­—
  411          //  @param      *val        å­˜å‚¨è¯»å–çš„æ•°æ®åœ°å€
  412          //  @since      v1.0
  413          //  Sample usage:
  414          //-------------------------------------------------------------------------------------------------------
             -------------
  415          static void imu963ra_simspi_r_reg_byte(uint8 cmd, uint8 *val)
  416          {
  417   1          IMU963RA_CS(0);
  418   1          cmd |= IMU963RA_SPI_R;
  419   1          imu963ra_simspi_wr_byte(cmd);
  420   1          *val = imu963ra_simspi_wr_byte(0);
  421   1          IMU963RA_CS(1);
  422   1      }
  423          
C251 COMPILER V5.60.0,  SEEKFREE_IMU963RA                                                  06/07/24  23:05:05  PAGE 8   

  424          //-------------------------------------------------------------------------------------------------------
             -------------
  425          //  @brief      è¯»å–cmdæ‰€å¯¹åº”çš„å¯„å­˜å™¨åœ°å€
  426          //  @param      cmd         å‘½ä»¤å­—
  427          //  @param      *val        å­˜å‚¨è¯»å–çš„æ•°æ®åœ°å€
  428          //  @param      num         è¯»å–çš„æ•°é‡
  429          //  @since      v1.0
  430          //  Sample usage:
  431          //-------------------------------------------------------------------------------------------------------
             -------------
  432          static void imu963ra_simspi_r_reg_bytes(uint8 cmd, uint8 *val, uint32 num)
  433          {
  434   1      
  435   1          cmd |= IMU963RA_SPI_R;
  436   1          imu963ra_simspi_wr_byte(cmd);
  437   1      
  438   1          while(num--)
  439   1          {
  440   2              *val++ = imu963ra_simspi_wr_byte(0);
  441   2          }
  442   1      }
  443          
  444          
  445          
  446          //-------------------------------------------------------------------------------------------------------
             -------------
  447          // å‡½æ•°ç®€ä»‹     IMU963RA å†™å¯„å­˜å™¨
  448          // å‚æ•°è¯´æ˜     reg             å¯„å­˜å™¨åœ°å€
  449          // å‚æ•°è¯´æ˜     dat            æ•°æ®
  450          // è¿”å›å‚æ•°     void
  451          // ä½¿ç”¨ç¤ºä¾‹     imu963ra_write_acc_gyro_register(IMU963RA_SLV0_CONFIG, 0x00);
  452          // å¤‡æ³¨ä¿¡æ¯     å†…éƒ¨è°ƒç”¨
  453          //-------------------------------------------------------------------------------------------------------
             -------------
  454          static void imu963ra_write_acc_gyro_register(uint8 reg, uint8 dat)
  455          {
  456   1          IMU963RA_CS(0);
  457   1          imu963ra_simspi_w_reg_byte(reg | IMU963RA_SPI_W, dat);
  458   1      
  459   1          IMU963RA_CS(1);
  460   1      }
  461          
  462          //-------------------------------------------------------------------------------------------------------
             -------------
  463          // å‡½æ•°ç®€ä»‹     IMU963RA è¯»å¯„å­˜å™¨
  464          // å‚æ•°è¯´æ˜     reg             å¯„å­˜å™¨åœ°å€
  465          // è¿”å›å‚æ•°     uint8           æ•°æ®
  466          // ä½¿ç”¨ç¤ºä¾‹     imu963ra_read_acc_gyro_register(IMU963RA_STATUS_MASTER);
  467          // å¤‡æ³¨ä¿¡æ¯     å†…éƒ¨è°ƒç”¨
  468          //-------------------------------------------------------------------------------------------------------
             -------------
  469          static uint8 imu963ra_read_acc_gyro_register(uint8 reg)
  470          {
  471   1          uint8 dat = 0;
  472   1          IMU963RA_CS(0);
  473   1          imu963ra_simspi_r_reg_byte(reg | IMU963RA_SPI_R, &dat);
  474   1          IMU963RA_CS(1);
  475   1          return dat;
  476   1      }
  477          
  478          //-------------------------------------------------------------------------------------------------------
             -------------
  479          // å‡½æ•°ç®€ä»‹     IMU963RA è¯»æ•°æ® å†…éƒ¨è°ƒç”¨
  480          // å‚æ•°è¯´æ˜     reg             å¯„å­˜å™¨åœ°å€
  481          // å‚æ•°è¯´æ˜     dat            æ•°æ®ç¼“å†²åŒº
  482          // å‚æ•°è¯´æ˜     len             æ•°æ®é•¿åº¦
C251 COMPILER V5.60.0,  SEEKFREE_IMU963RA                                                  06/07/24  23:05:05  PAGE 9   

  483          // è¿”å›å‚æ•°     void
  484          // ä½¿ç”¨ç¤ºä¾‹     imu963ra_read_acc_gyro_registers(IMU963RA_OUTX_L_A, dat, 6);
  485          // å¤‡æ³¨ä¿¡æ¯     å†…éƒ¨è°ƒç”¨
  486          //-------------------------------------------------------------------------------------------------------
             -------------
  487          static void imu963ra_read_acc_gyro_registers(uint8 reg, uint8 *dat, uint32 len)
  488          {
  489   1          IMU963RA_CS(0);
  490   1          imu963ra_simspi_r_reg_bytes( reg | IMU963RA_SPI_R, dat, len);
  491   1      
  492   1          IMU963RA_CS(1);
  493   1      }
  494          #endif
  495          
  496          //-------------------------------------------------------------------------------------------------------
             -------------
  497          // å‡½æ•°ç®€ä»‹     IMU963RA ä½œä¸º IIC ä¸»æœºå‘ç£åŠ›è®¡å†™æ•°æ®
  498          // å‚æ•°è¯´æ˜     addr            ç›®æ ‡åœ°å€
  499          // å‚æ•°è¯´æ˜     reg             ç›®æ ‡å¯„å­˜å™¨
  500          // å‚æ•°è¯´æ˜     dat            æ•°æ®
  501          // è¿”å›å‚æ•°     uint8           1-å¤±è´¥ 0-æˆåŠŸ
  502          // ä½¿ç”¨ç¤ºä¾‹     imu963ra_write_mag_register(IMU963RA_MAG_ADDR, IMU963RA_MAG_CONTROL2, 0x80);
  503          // å¤‡æ³¨ä¿¡æ¯     å†…éƒ¨è°ƒç”¨
  504          //-------------------------------------------------------------------------------------------------------
             -------------
  505          static uint8 imu963ra_write_mag_register (uint8 addr, uint8 reg, uint8 dat)
  506          {
  507   1          uint8 return_state = 0;
  508   1          uint16 timeout_count = 0;
  509   1      
  510   1          addr = addr << 1;
  511   1          imu963ra_write_acc_gyro_register(IMU963RA_SLV0_CONFIG, 0x00);               // ä»æœº0é…ç½®æ¸…é™¤
  512   1          imu963ra_write_acc_gyro_register(IMU963RA_SLV0_ADD, addr | 0);              // è®¾ç½®åœ°ç£è®¡åœ°å€ï
             -¼ˆæ³¨æ„è¿™é‡Œéœ€è¦è®¾ç½®8ä½çš„I2Cåœ°å€ï¼‰ 0x2C
  513   1          imu963ra_write_acc_gyro_register(IMU963RA_SLV0_SUBADD, reg);                // éœ€è¦å†™å…¥çš„å¯„å­˜å
             -™¨åœ°å€
  514   1          imu963ra_write_acc_gyro_register(IMU963RA_DATAWRITE_SLV0, dat);            // éœ€è¦å†™å…¥çš„æ•°æ®
  515   1          imu963ra_write_acc_gyro_register(IMU963RA_MASTER_CONFIG, 0x4C);             // ä»…åœ¨ç¬¬ä¸€ä¸ªå‘¨æœŸå
             -¯ç”¨é€šè®¯ å¼€å¯ä¸Šæ‹‰ I2Cä¸»æœºä½¿èƒ½
  516   1      
  517   1          // ç­‰å¾…é€šè®¯æˆåŠŸ
  518   1          while(0 == (0x80 & imu963ra_read_acc_gyro_register(IMU963RA_STATUS_MASTER)))
  519   1          {
  520   2              if(timeout_count ++ > IMU963RA_TIMEOUT_COUNT)
  521   2              {
  522   3                  return_state = 1;
  523   3                  break;
  524   3              }
  525   2      
  526   2              delay_ms(2);
  527   2          }
  528   1      
  529   1          return return_state;
  530   1      }
  531          
  532          //-------------------------------------------------------------------------------------------------------
             -------------
  533          // å‡½æ•°ç®€ä»‹     IMU963RA ä½œä¸º IIC ä¸»æœºå‘ç£åŠ›è®¡è¯»æ•°æ®
  534          // å‚æ•°è¯´æ˜     addr            ç›®æ ‡åœ°å€
  535          // å‚æ•°è¯´æ˜     reg             ç›®æ ‡å¯„å­˜å™¨
  536          // è¿”å›å‚æ•°     uint8           è¯»å–çš„æ•°æ®
  537          // ä½¿ç”¨ç¤ºä¾‹     imu963ra_read_mag_register(IMU963RA_MAG_ADDR, IMU963RA_MAG_CHIP_ID);
  538          // å¤‡æ³¨ä¿¡æ¯     å†…éƒ¨è°ƒç”¨
  539          //-------------------------------------------------------------------------------------------------------
             -------------
  540          static uint8 imu963ra_read_mag_register (uint8 addr, uint8 reg)
C251 COMPILER V5.60.0,  SEEKFREE_IMU963RA                                                  06/07/24  23:05:05  PAGE 10  

  541          {
  542   1          uint16 timeout_count = 0;
  543   1      
  544   1          addr = addr << 1;
  545   1          imu963ra_write_acc_gyro_register(IMU963RA_SLV0_ADD, addr | 1);              // è®¾ç½®åœ°ç£è®¡åœ°å€ï
             -¼ˆæ³¨æ„è¿™é‡Œéœ€è¦è®¾ç½®8ä½çš„I2Cåœ°å€ï¼‰ 0x2C
  546   1          imu963ra_write_acc_gyro_register(IMU963RA_SLV0_SUBADD, reg);                // éœ€è¦è¯»å–çš„å¯„å­˜å
             -™¨åœ°å€
  547   1          imu963ra_write_acc_gyro_register(IMU963RA_SLV0_CONFIG, 0x01);
  548   1          imu963ra_write_acc_gyro_register(IMU963RA_MASTER_CONFIG, 0x4C);             // ä»…åœ¨ç¬¬ä¸€ä¸ªå‘¨æœŸå
             -¯ç”¨é€šè®¯ å¼€å¯ä¸Šæ‹‰ I2Cä¸»æœºä½¿èƒ½
  549   1      
  550   1          // ç­‰å¾…é€šè®¯æˆåŠŸ
  551   1          while(0 == (0x01 & imu963ra_read_acc_gyro_register(IMU963RA_STATUS_MASTER)))
  552   1          {
  553   2              if(timeout_count ++ > IMU963RA_TIMEOUT_COUNT)
  554   2              {
  555   3                  break;
  556   3              }
  557   2      
  558   2              delay_ms(2);
  559   2          }
  560   1      
  561   1          return (imu963ra_read_acc_gyro_register(IMU963RA_SENSOR_HUB_1));            // è¿”å›è¯»å–åˆ°çš„æ•°æ
             -®
  562   1      }
  563          
  564          //-------------------------------------------------------------------------------------------------------
             -------------
  565          // å‡½æ•°ç®€ä»‹     IMU963RA ä½œä¸º IIC ä¸»æœºå‘ç£åŠ›è®¡è‡ªåŠ¨å†™æ•°æ®
  566          // å‚æ•°è¯´æ˜     addr            ç›®æ ‡åœ°å€
  567          // å‚æ•°è¯´æ˜     reg             ç›®æ ‡å¯„å­˜å™¨
  568          // è¿”å›å‚æ•°     void
  569          // ä½¿ç”¨ç¤ºä¾‹     imu963ra_connect_mag(IMU963RA_MAG_ADDR, IMU963RA_MAG_OUTX_L);
  570          // å¤‡æ³¨ä¿¡æ¯     å†…éƒ¨è°ƒç”¨
  571          //-------------------------------------------------------------------------------------------------------
             -------------
  572          static void imu963ra_connect_mag (uint8 addr, uint8 reg)
  573          {
  574   1          addr = addr << 1;
  575   1      
  576   1          imu963ra_write_acc_gyro_register(IMU963RA_SLV0_ADD, addr | 1);              // è®¾ç½®åœ°ç£è®¡åœ°å€ï
             -¼ˆæ³¨æ„è¿™é‡Œéœ€è¦è®¾ç½®8ä½çš„I2Cåœ°å€ï¼‰ 0x2C
  577   1          imu963ra_write_acc_gyro_register(IMU963RA_SLV0_SUBADD, reg);                // éœ€è¦è¯»å–çš„å¯„å­˜å
             -™¨åœ°å€
  578   1          imu963ra_write_acc_gyro_register(IMU963RA_SLV0_CONFIG, 0x06);
  579   1          imu963ra_write_acc_gyro_register(IMU963RA_MASTER_CONFIG, 0x6C);             // ä»…åœ¨ç¬¬ä¸€ä¸ªå‘¨æœŸå
             -¯ç”¨é€šè®¯ å¼€å¯ä¸Šæ‹‰ I2Cä¸»æœºä½¿èƒ½
  580   1      }
  581          
  582          
  583          //-------------------------------------------------------------------------------------------------------
             -------------
  584          // å‡½æ•°ç®€ä»‹     IMU963RA å…­è½´è‡ªæ£€ å†…éƒ¨è°ƒç”¨
  585          // å‚æ•°è¯´æ˜     void
  586          // è¿”å›å‚æ•°     uint8           1-è‡ªæ£€å¤±è´¥ 0-è‡ªæ£€æˆåŠŸ
  587          // ä½¿ç”¨ç¤ºä¾‹     imu963ra_acc_gyro_self_check();
  588          // å¤‡æ³¨ä¿¡æ¯     å†…éƒ¨è°ƒç”¨
  589          //-------------------------------------------------------------------------------------------------------
             -------------
  590          static uint8 imu963ra_acc_gyro_self_check (void)
  591          {
  592   1          uint8 return_state = 0;
  593   1          uint8 dat = 0;
  594   1          uint16 timeout_count = 0;
  595   1      
C251 COMPILER V5.60.0,  SEEKFREE_IMU963RA                                                  06/07/24  23:05:05  PAGE 11  

  596   1          while(0x6B != dat)                                                          // åˆ¤æ–­ ID æ˜¯å¦æ­£ç¡®
  597   1          {
  598   2              if(timeout_count++ > IMU963RA_TIMEOUT_COUNT)
  599   2              {
  600   3                  return_state = 1;
  601   3                  break;
  602   3              }
  603   2      
  604   2              dat = imu963ra_read_acc_gyro_register(IMU963RA_WHO_AM_I);
  605   2              delay_ms(10);
  606   2          }
  607   1      
  608   1          return return_state;
  609   1      }
  610          
  611          //-------------------------------------------------------------------------------------------------------
             -------------
  612          // å‡½æ•°ç®€ä»‹     IMU963RA ç£åŠ›è®¡è‡ªæ£€ å†…éƒ¨è°ƒç”¨
  613          // å‚æ•°è¯´æ˜     void
  614          // è¿”å›å‚æ•°     uint8           1-è‡ªæ£€å¤±è´¥ 0-è‡ªæ£€æˆåŠŸ
  615          // ä½¿ç”¨ç¤ºä¾‹     imu963ra_mag_self_check();
  616          // å¤‡æ³¨ä¿¡æ¯     å†…éƒ¨è°ƒç”¨
  617          //-------------------------------------------------------------------------------------------------------
             -------------
  618          static uint8 imu963ra_mag_self_check (void)
  619          {
  620   1          uint8 return_state = 0;
  621   1          uint8 dat = 0;
  622   1          uint16 timeout_count = 0;
  623   1      
  624   1          while(0xff != dat)                                                          // åˆ¤æ–­ ID æ˜¯å¦æ­£ç¡®
  625   1          {
  626   2              if(timeout_count++ > IMU963RA_TIMEOUT_COUNT)
  627   2              {
  628   3                  return_state = 1;
  629   3                  break;
  630   3              }
  631   2      
  632   2              dat = imu963ra_read_mag_register(IMU963RA_MAG_ADDR, IMU963RA_MAG_CHIP_ID);
  633   2              delay_ms(10);
  634   2          }
  635   1      
  636   1          return return_state;
  637   1      }
  638          
  639          //-------------------------------------------------------------------------------------------------------
             -------------
  640          // å‡½æ•°ç®€ä»‹     è·å– IMU963RA åŠ é€Ÿåº¦è®¡æ•°æ®
  641          // å‚æ•°è¯´æ˜     void
  642          // è¿”å›å‚æ•°     void
  643          // ä½¿ç”¨ç¤ºä¾‹     imu963ra_get_acc();
  644          // å¤‡æ³¨ä¿¡æ¯     æ‰§è¡Œè¯¥å‡½æ•°åï¼Œç›´æ¥æŸ¥çœ‹å¯¹åº”çš„å˜é‡å³å¯
  645          //-------------------------------------------------------------------------------------------------------
             -------------
  646          void imu963ra_get_acc (void)
  647          {
  648   1          uint8 dat[6];
  649   1      
  650   1          imu963ra_read_acc_gyro_registers(IMU963RA_OUTX_L_A, dat, 6);
  651   1          imu963ra_acc_x = (int16)(((uint16)dat[1] << 8 | dat[0]));
  652   1          imu963ra_acc_y = (int16)(((uint16)dat[3] << 8 | dat[2]));
  653   1          imu963ra_acc_z = (int16)(((uint16)dat[5] << 8 | dat[4]));
  654   1      }
  655          
  656          
  657          //-------------------------------------------------------------------------------------------------------
C251 COMPILER V5.60.0,  SEEKFREE_IMU963RA                                                  06/07/24  23:05:05  PAGE 12  

             -------------
  658          // å‡½æ•°ç®€ä»‹     è·å–IMU963RAé™€èºä»ªæ•°æ®
  659          // å‚æ•°è¯´æ˜     void
  660          // è¿”å›å‚æ•°     void
  661          // ä½¿ç”¨ç¤ºä¾‹     imu963ra_get_gyro();
  662          // å¤‡æ³¨ä¿¡æ¯     æ‰§è¡Œè¯¥å‡½æ•°åï¼Œç›´æ¥æŸ¥çœ‹å¯¹åº”çš„å˜é‡å³å¯
  663          //-------------------------------------------------------------------------------------------------------
             -------------
  664          void imu963ra_get_gyro (void)
  665          {
  666   1          uint8 dat[6];
  667   1      
  668   1          imu963ra_read_acc_gyro_registers(IMU963RA_OUTX_L_G, dat, 6);
  669   1          imu963ra_gyro_x = (int16)(((uint16)dat[1] << 8 | dat[0]));
  670   1          imu963ra_gyro_y = (int16)(((uint16)dat[3] << 8 | dat[2]));
  671   1          imu963ra_gyro_z = (int16)(((uint16)dat[5] << 8 | dat[4]));
  672   1      }
  673          
  674          
  675          //-------------------------------------------------------------------------------------------------------
             -------------
  676          // å‡½æ•°ç®€ä»‹     è·å– IMU963RA ç£åŠ›è®¡æ•°æ®
  677          // å‚æ•°è¯´æ˜     void
  678          // è¿”å›å‚æ•°     void
  679          // ä½¿ç”¨ç¤ºä¾‹     imu963ra_get_mag();
  680          // å¤‡æ³¨ä¿¡æ¯     æ‰§è¡Œè¯¥å‡½æ•°åï¼Œç›´æ¥æŸ¥çœ‹å¯¹åº”çš„å˜é‡å³å¯
  681          //-------------------------------------------------------------------------------------------------------
             -------------
  682          void imu963ra_get_mag (void)
  683          {
  684   1          uint8 temp_status;
  685   1          uint8 dat[6];
  686   1      
  687   1          imu963ra_write_acc_gyro_register(IMU963RA_FUNC_CFG_ACCESS, 0x40);
  688   1          temp_status = imu963ra_read_acc_gyro_register(IMU963RA_STATUS_MASTER);
  689   1      
  690   1          if(0x01 & temp_status)
  691   1          {
  692   2              imu963ra_read_acc_gyro_registers(IMU963RA_SENSOR_HUB_1, dat, 6);
  693   2              imu963ra_mag_x = (int16)(((uint16)dat[1] << 8 | dat[0]));
  694   2              imu963ra_mag_y = (int16)(((uint16)dat[3] << 8 | dat[2]));
  695   2              imu963ra_mag_z = (int16)(((uint16)dat[5] << 8 | dat[4]));
  696   2          }
  697   1      
  698   1          imu963ra_write_acc_gyro_register(IMU963RA_FUNC_CFG_ACCESS, 0x00);
  699   1      }
  700          
  701          //-------------------------------------------------------------------------------------------------------
             -------------
  702          // å‡½æ•°ç®€ä»‹     å°† IMU963RA åŠ é€Ÿåº¦è®¡æ•°æ®è½¬æ¢ä¸ºå®é™…ç‰©ç†æ•°æ®
  703          // å‚æ•°è¯´æ˜     gyro_value      ä»»æ„è½´çš„åŠ é€Ÿåº¦è®¡æ•°æ®
  704          // è¿”å›å‚æ•°     void
  705          // ä½¿ç”¨ç¤ºä¾‹     float dat = imu963ra_acc_transition(imu963ra_acc_x);           // å•ä½ä¸º g(m/s^2)
  706          // å¤‡æ³¨ä¿¡æ¯
  707          //-------------------------------------------------------------------------------------------------------
             -------------
  708          float imu963ra_acc_transition (int16 acc_value)
  709          {
  710   1          float acc_dat = 0;
  711   1      
  712   1          switch(IMU963RA_ACC_SAMPLE)
  713   1          {
  714   2              case 0x30:
  715   2                  acc_dat = (float)acc_value / 16393;
  716   2                  break;                  // 0x30 åŠ é€Ÿåº¦é‡ç¨‹ä¸º:Â±2G      è·å–åˆ°çš„åŠ é€Ÿåº¦è®¡æ•°æ® é
             -™¤ä»¥ 16393 ï¼Œå¯ä»¥è½¬åŒ–ä¸ºå¸¦ç‰©ç†å•ä½çš„æ•°æ®ï¼Œå•ä½ï¼šg(m/s^2)
C251 COMPILER V5.60.0,  SEEKFREE_IMU963RA                                                  06/07/24  23:05:05  PAGE 13  

  717   2      
  718   2              case 0x38:
  719   2                  acc_dat = (float)acc_value / 8197;
  720   2                  break;                  // 0x38 åŠ é€Ÿåº¦é‡ç¨‹ä¸º:Â±4G      è·å–åˆ°çš„åŠ é€Ÿåº¦è®¡æ•°æ® é
             -™¤ä»¥ 8197 ï¼Œ å¯ä»¥è½¬åŒ–ä¸ºå¸¦ç‰©ç†å•ä½çš„æ•°æ®ï¼Œå•ä½ï¼šg(m/s^2)
  721   2      
  722   2              case 0x3C:
  723   2                  acc_dat = (float)acc_value / 4098;
  724   2                  break;                  // 0x3C åŠ é€Ÿåº¦é‡ç¨‹ä¸º:Â±8G      è·å–åˆ°çš„åŠ é€Ÿåº¦è®¡æ•°æ® é
             -™¤ä»¥ 4098 ï¼Œ å¯ä»¥è½¬åŒ–ä¸ºå¸¦ç‰©ç†å•ä½çš„æ•°æ®ï¼Œå•ä½ï¼šg(m/s^2)
  725   2      
  726   2              case 0x34:
  727   2                  acc_dat = (float)acc_value / 2049;
  728   2                  break;                  // 0x34 åŠ é€Ÿåº¦é‡ç¨‹ä¸º:Â±16G     è·å–åˆ°çš„åŠ é€Ÿåº¦è®¡æ•°æ® é
             -™¤ä»¥ 2049 ï¼Œ å¯ä»¥è½¬åŒ–ä¸ºå¸¦ç‰©ç†å•ä½çš„æ•°æ®ï¼Œå•ä½ï¼šg(m/s^2)
  729   2      
  730   2              default:
  731   2                  break;
  732   2          }
  733   1      
  734   1          return acc_dat;
  735   1      }
  736          
  737          //-------------------------------------------------------------------------------------------------------
             -------------
  738          // å‡½æ•°ç®€ä»‹     å°† IMU963RA é™€èºä»ªæ•°æ®è½¬æ¢ä¸ºå®é™…ç‰©ç†æ•°æ®
  739          // å‚æ•°è¯´æ˜     gyro_value      ä»»æ„è½´çš„é™€èºä»ªæ•°æ®
  740          // è¿”å›å‚æ•°     void
  741          // ä½¿ç”¨ç¤ºä¾‹     float dat = imu963ra_gyro_transition(imu963ra_gyro_x);         // å•ä½ä¸ºÂ°/s
  742          // å¤‡æ³¨ä¿¡æ¯
  743          //-------------------------------------------------------------------------------------------------------
             -------------
  744          float imu963ra_gyro_transition (int16 gyro_value)
  745          {
  746   1          float gyro_dat = 0;
  747   1      
  748   1          switch(IMU963RA_GYR_SAMPLE)
  749   1          {
  750   2              case 0x52:
  751   2                  gyro_dat = (float)gyro_value / 228.6f;
  752   2                  break;              //  0x52 é™€èºä»ªé‡ç¨‹ä¸º:Â±125dps  è·å–åˆ°çš„é™€èºä»ªæ•°æ®é™¤ä»¥ 2
             -28.6ï¼Œ   å¯ä»¥è½¬åŒ–ä¸ºå¸¦ç‰©ç†å•ä½çš„æ•°æ®ï¼Œå•ä½ä¸ºï¼šÂ°/s
  753   2      
  754   2              case 0x50:
  755   2                  gyro_dat = (float)gyro_value / 114.3f;
  756   2                  break;              //  0x50 é™€èºä»ªé‡ç¨‹ä¸º:Â±250dps  è·å–åˆ°çš„é™€èºä»ªæ•°æ®é™¤ä»¥ 1
             -14.3ï¼Œ   å¯ä»¥è½¬åŒ–ä¸ºå¸¦ç‰©ç†å•ä½çš„æ•°æ®ï¼Œå•ä½ä¸ºï¼šÂ°/s
  757   2      
  758   2              case 0x54:
  759   2                  gyro_dat = (float)gyro_value / 57.1f;
  760   2                  break;              //  0x54 é™€èºä»ªé‡ç¨‹ä¸º:Â±500dps  è·å–åˆ°çš„é™€èºä»ªæ•°æ®é™¤ä»¥ 5
             -7.1ï¼Œ    å¯ä»¥è½¬åŒ–ä¸ºå¸¦ç‰©ç†å•ä½çš„æ•°æ®ï¼Œå•ä½ä¸ºï¼šÂ°/s
  761   2      
  762   2              case 0x58:
  763   2                  gyro_dat = (float)gyro_value / 28.6f;
  764   2                  break;              //  0x58 é™€èºä»ªé‡ç¨‹ä¸º:Â±1000dps è·å–åˆ°çš„é™€èºä»ªæ•°æ®é™¤ä»¥ 2
             -8.6ï¼Œ    å¯ä»¥è½¬åŒ–ä¸ºå¸¦ç‰©ç†å•ä½çš„æ•°æ®ï¼Œå•ä½ä¸ºï¼šÂ°/s
  765   2      
  766   2              case 0x5C:
  767   2                  gyro_dat = (float)gyro_value / 14.3f;
  768   2                  break;              //  0x5C é™€èºä»ªé‡ç¨‹ä¸º:Â±2000dps è·å–åˆ°çš„é™€èºä»ªæ•°æ®é™¤ä»¥ 1
             -4.3ï¼Œ    å¯ä»¥è½¬åŒ–ä¸ºå¸¦ç‰©ç†å•ä½çš„æ•°æ®ï¼Œå•ä½ä¸ºï¼šÂ°/s
  769   2      
  770   2              case 0x51:
  771   2                  gyro_dat = (float)gyro_value / 7.1f;
  772   2                  break;              //  0x51 é™€èºä»ªé‡ç¨‹ä¸º:Â±4000dps è·å–åˆ°çš„é™€èºä»ªæ•°æ®é™¤ä»¥ 7
C251 COMPILER V5.60.0,  SEEKFREE_IMU963RA                                                  06/07/24  23:05:05  PAGE 14  

             -.1ï¼Œ     å¯ä»¥è½¬åŒ–ä¸ºå¸¦ç‰©ç†å•ä½çš„æ•°æ®ï¼Œå•ä½ä¸ºï¼šÂ°/s
  773   2      
  774   2              default:
  775   2                  break;
  776   2          }
  777   1      
  778   1          return gyro_dat;
  779   1      }
  780          
  781          //-------------------------------------------------------------------------------------------------------
             -------------
  782          // å‡½æ•°ç®€ä»‹     å°† IMU963RA åœ°ç£è®¡æ•°æ®è½¬æ¢ä¸ºå®é™…ç‰©ç†æ•°æ®
  783          // å‚æ•°è¯´æ˜     mag_value       ä»»æ„è½´çš„åœ°ç£è®¡æ•°æ®
  784          // è¿”å›å‚æ•°     void
  785          // ä½¿ç”¨ç¤ºä¾‹     float dat = imu963ra_mag_transition(imu963ra_mag_x);          // å•ä½ä¸ºG(é«˜æ–¯)
  786          // å¤‡æ³¨ä¿¡æ¯
  787          //-------------------------------------------------------------------------------------------------------
             -------------
  788          float imu963ra_mag_transition (int16 mag_value)
  789          {
  790   1          float mag_dat = 0;
  791   1      
  792   1          switch(IMU963RA_MAG_SAMPLE)
  793   1          {
  794   2              case 0x19:
  795   2                  mag_dat = (float)mag_value / 3000;
  796   2                  break;                  //  0x19 ç£åŠ›è®¡é‡ç¨‹ä¸º:8G     è·å–åˆ°çš„åŠ é€Ÿåº¦è®¡æ•°æ® é™¤
             -ä»¥3000ï¼Œ å¯ä»¥è½¬åŒ–ä¸ºå¸¦ç‰©ç†å•ä½çš„æ•°æ®ï¼Œå•ä½ï¼šG(é«˜æ–¯)
  797   2      
  798   2              case 0x09:
  799   2                  mag_dat = (float)mag_value / 12000;
  800   2                  break;                  //  0x09 ç£åŠ›è®¡é‡ç¨‹ä¸º:2G     è·å–åˆ°çš„åŠ é€Ÿåº¦è®¡æ•°æ® é™¤
             -ä»¥12000ï¼Œå¯ä»¥è½¬åŒ–ä¸ºå¸¦ç‰©ç†å•ä½çš„æ•°æ®ï¼Œå•ä½ï¼šG(é«˜æ–¯)
  801   2      
  802   2              default:
  803   2                  break;
  804   2          }
  805   1      
  806   1          return mag_dat;
  807   1      }
  808          
  809          //-------------------------------------------------------------------------------------------------------
             -------------
  810          // å‡½æ•°ç®€ä»‹     åˆå§‹åŒ– IMU963RA
  811          // å‚æ•°è¯´æ˜     void
  812          // è¿”å›å‚æ•°     uint8           1-åˆå§‹åŒ–å¤±è´¥ 0-åˆå§‹åŒ–æˆåŠŸ
  813          // ä½¿ç”¨ç¤ºä¾‹     imu963ra_init();
  814          // å¤‡æ³¨ä¿¡æ¯
  815          //-------------------------------------------------------------------------------------------------------
             -------------
  816          uint8 imu963ra_init (void)
  817          {
  818   1          uint8 return_state = 0;
  819   1          delay_ms(10);                                                        // ä¸Šç”µå»¶æ—¶
  820   1      
  821   1      //#if IMU963RA_USE_SOFT_IIC
  822   1      //    soft_iic_init(&imu963ra_iic_struct, IMU963RA_DEV_ADDR, IMU963RA_SOFT_IIC_DELAY, IMU963RA_SCL_PIN, I
             -MU963RA_SDA_PIN);
  823   1      //#else
  824   1      //    spi_init(IMU963RA_SPI, SPI_MODE0, IMU963RA_SPI_SPEED, IMU963RA_SPC_PIN, IMU963RA_SDI_PIN, IMU963RA_
             -SDO_PIN, SPI_CS_NULL);
  825   1      //    gpio_init(IMU963RA_CS_PIN, GPO, GPIO_LOW, GPO_PUSH_PULL);
  826   1      //#endif
  827   1      
  828   1          do
  829   1          {
C251 COMPILER V5.60.0,  SEEKFREE_IMU963RA                                                  06/07/24  23:05:05  PAGE 15  

  830   2              imu963ra_write_acc_gyro_register(IMU963RA_FUNC_CFG_ACCESS, 0x00);       // å…³é—­HUBå¯„å­˜å™¨è®¿é
             -—®
  831   2              imu963ra_write_acc_gyro_register(IMU963RA_CTRL3_C, 0x01);               // å¤ä½è®¾å¤‡
  832   2              delay_ms(2);
  833   2              imu963ra_write_acc_gyro_register(IMU963RA_FUNC_CFG_ACCESS, 0x00);       // å…³é—­HUBå¯„å­˜å™¨è®¿é
             -—®
  834   2      
  835   2              if(imu963ra_acc_gyro_self_check())
  836   2              {
  837   3      //                      while(1)
  838   3      //                      {
  839   3                  printf( "IMU963RA acc and gyro self check error.\r\n");
  840   3      //                              delay_ms(200);
  841   3      //                      };
  842   3      
  843   3      
  844   3                  return_state = 1;
  845   3                  break;
  846   3              }
  847   2      
  848   2              imu963ra_write_acc_gyro_register(IMU963RA_INT1_CTRL, 0x03);             // å¼€å¯é™€èºä»ª åŠ é€Ÿ
             -åº¦æ•°æ®å°±ç»ªä¸­æ–­
  849   2              imu963ra_write_acc_gyro_register(IMU963RA_CTRL1_XL, IMU963RA_GYR_SAMPLE);   // è®¾ç½®åŠ é€Ÿåº¦è®¡
             -é‡ç¨‹ Â±8G ä»¥åŠæ•°æ®è¾“å‡ºé€Ÿç‡ 52hz ä»¥åŠåŠ é€Ÿåº¦ä¿¡æ¯ä»ç¬¬ä¸€çº§æ»¤æ³¢å™¨è¾“å‡º
  850   2              // IMU963RA_CTRL1_XL å¯„å­˜å™¨
  851   2              // è®¾ç½®ä¸º:0x30 åŠ é€Ÿåº¦é‡ç¨‹ä¸º:Â±2G      è·å–åˆ°çš„åŠ é€Ÿåº¦è®¡æ•°æ® é™¤ä»¥16393ï¼Œå¯ä»
             -¥è½¬åŒ–ä¸ºå¸¦ç‰©ç†å•ä½çš„æ•°æ®ï¼Œå•ä½ï¼šg(m/s^2)
  852   2              // è®¾ç½®ä¸º:0x38 åŠ é€Ÿåº¦é‡ç¨‹ä¸º:Â±4G      è·å–åˆ°çš„åŠ é€Ÿåº¦è®¡æ•°æ® é™¤ä»¥8197ï¼Œ å¯ä»
             -¥è½¬åŒ–ä¸ºå¸¦ç‰©ç†å•ä½çš„æ•°æ®ï¼Œå•ä½ï¼šg(m/s^2)
  853   2              // è®¾ç½®ä¸º:0x3C åŠ é€Ÿåº¦é‡ç¨‹ä¸º:Â±8G      è·å–åˆ°çš„åŠ é€Ÿåº¦è®¡æ•°æ® é™¤ä»¥4098ï¼Œ å¯ä»
             -¥è½¬åŒ–ä¸ºå¸¦ç‰©ç†å•ä½çš„æ•°æ®ï¼Œå•ä½ï¼šg(m/s^2)
  854   2              // è®¾ç½®ä¸º:0x34 åŠ é€Ÿåº¦é‡ç¨‹ä¸º:Â±16G     è·å–åˆ°çš„åŠ é€Ÿåº¦è®¡æ•°æ® é™¤ä»¥2049ï¼Œ å¯ä»
             -¥è½¬åŒ–ä¸ºå¸¦ç‰©ç†å•ä½çš„æ•°æ®ï¼Œå•ä½ï¼šg(m/s^2)
  855   2      
  856   2              imu963ra_write_acc_gyro_register(IMU963RA_CTRL2_G, IMU963RA_ACC_SAMPLE);    // è®¾ç½®é™€èºä»ªè®¡
             -é‡ç¨‹ Â±2000dps ä»¥åŠæ•°æ®è¾“å‡ºé€Ÿç‡ 208hz
  857   2              // IMU963RA_CTRL2_G å¯„å­˜å™¨
  858   2              // è®¾ç½®ä¸º:0x52 é™€èºä»ªé‡ç¨‹ä¸º:Â±125dps  è·å–åˆ°çš„é™€èºä»ªæ•°æ®é™¤ä»¥228.6ï¼Œ   å¯ä»¥
             -è½¬åŒ–ä¸ºå¸¦ç‰©ç†å•ä½çš„æ•°æ®ï¼Œå•ä½ä¸ºï¼šÂ°/s
  859   2              // è®¾ç½®ä¸º:0x50 é™€èºä»ªé‡ç¨‹ä¸º:Â±250dps  è·å–åˆ°çš„é™€èºä»ªæ•°æ®é™¤ä»¥114.3ï¼Œ   å¯ä»¥
             -è½¬åŒ–ä¸ºå¸¦ç‰©ç†å•ä½çš„æ•°æ®ï¼Œå•ä½ä¸ºï¼šÂ°/s
  860   2              // è®¾ç½®ä¸º:0x54 é™€èºä»ªé‡ç¨‹ä¸º:Â±500dps  è·å–åˆ°çš„é™€èºä»ªæ•°æ®é™¤ä»¥57.1ï¼Œ    å¯ä»¥
             -è½¬åŒ–ä¸ºå¸¦ç‰©ç†å•ä½çš„æ•°æ®ï¼Œå•ä½ä¸ºï¼šÂ°/s
  861   2              // è®¾ç½®ä¸º:0x58 é™€èºä»ªé‡ç¨‹ä¸º:Â±1000dps è·å–åˆ°çš„é™€èºä»ªæ•°æ®é™¤ä»¥28.6ï¼Œ    å¯ä»¥
             -è½¬åŒ–ä¸ºå¸¦ç‰©ç†å•ä½çš„æ•°æ®ï¼Œå•ä½ä¸ºï¼šÂ°/s
  862   2              // è®¾ç½®ä¸º:0x5C é™€èºä»ªé‡ç¨‹ä¸º:Â±2000dps è·å–åˆ°çš„é™€èºä»ªæ•°æ®é™¤ä»¥14.3ï¼Œ    å¯ä»¥
             -è½¬åŒ–ä¸ºå¸¦ç‰©ç†å•ä½çš„æ•°æ®ï¼Œå•ä½ä¸ºï¼šÂ°/s
  863   2              // è®¾ç½®ä¸º:0x51 é™€èºä»ªé‡ç¨‹ä¸º:Â±4000dps è·å–åˆ°çš„é™€èºä»ªæ•°æ®é™¤ä»¥7.1ï¼Œ     å¯ä»¥
             -è½¬åŒ–ä¸ºå¸¦ç‰©ç†å•ä½çš„æ•°æ®ï¼Œå•ä½ä¸ºï¼šÂ°/s
  864   2      
  865   2              imu963ra_write_acc_gyro_register(IMU963RA_CTRL3_C, 0x44);               // ä½¿èƒ½é™€èºä»ªæ•°å­—ä
             -½é€šæ»¤æ³¢å™¨
  866   2              imu963ra_write_acc_gyro_register(IMU963RA_CTRL4_C, 0x02);               // ä½¿èƒ½æ•°å­—ä½é€šæ»¤æ
             -³¢å™¨
  867   2              imu963ra_write_acc_gyro_register(IMU963RA_CTRL5_C, 0x00);               // åŠ é€Ÿåº¦è®¡ä¸é™€èºä
             -»ªå››èˆäº”å…¥
  868   2              imu963ra_write_acc_gyro_register(IMU963RA_CTRL6_C, 0x00);               // å¼€å¯åŠ é€Ÿåº¦è®¡é«˜æ
             -€§èƒ½æ¨¡å¼ é™€èºä»ªä½é€šæ»¤æ³¢ 133hz
  869   2              imu963ra_write_acc_gyro_register(IMU963RA_CTRL7_G, 0x00);               // å¼€å¯é™€èºä»ªé«˜æ€§è
             -ƒ½æ¨¡å¼ å…³é—­é«˜é€šæ»¤æ³¢
  870   2              imu963ra_write_acc_gyro_register(IMU963RA_CTRL9_XL, 0x01);              // å…³é—­I3Cæ¥å£
  871   2      
  872   2              imu963ra_write_acc_gyro_register(IMU963RA_FUNC_CFG_ACCESS, 0x40);       // å¼€å¯HUBå¯„å­˜å™¨è®¿é
             -—® ç”¨äºé…ç½®åœ°ç£è®¡
  873   2              imu963ra_write_acc_gyro_register(IMU963RA_MASTER_CONFIG, 0x80);         // å¤ä½I2Cä¸»æœº
  874   2              delay_ms(2);
C251 COMPILER V5.60.0,  SEEKFREE_IMU963RA                                                  06/07/24  23:05:05  PAGE 16  

  875   2              imu963ra_write_acc_gyro_register(IMU963RA_MASTER_CONFIG, 0x00);         // æ¸…é™¤å¤ä½æ ‡å¿—
  876   2              delay_ms(2);
  877   2      
  878   2              imu963ra_write_mag_register(IMU963RA_MAG_ADDR, IMU963RA_MAG_CONTROL2, 0x80);// å¤ä½è¿æ¥çš„å¤–
             -è®¾
  879   2              delay_ms(2);
  880   2              imu963ra_write_mag_register(IMU963RA_MAG_ADDR, IMU963RA_MAG_CONTROL2, 0x00);
  881   2              delay_ms(2);
  882   2      
  883   2      
  884   2              if(imu963ra_mag_self_check())
  885   2              {
  886   3      //                      while(1)
  887   3      //                      {
  888   3                  printf("IMU963RA mag self check error.\r\n");
  889   3      //                              delay_ms(200);
  890   3      //                      };
  891   3      
  892   3      
  893   3                  return_state = 1;
  894   3                  break;
  895   3              }
  896   2      
  897   2              imu963ra_write_mag_register(IMU963RA_MAG_ADDR, IMU963RA_MAG_CONTROL1, IMU963RA_MAG_SAMPLE); // è®
             -¾ç½®ç£åŠ›è®¡é‡ç¨‹8G è¾“å‡ºé€Ÿç‡100hz è¿ç»­æ¨¡å¼
  898   2              // IMU963RA_MAG_ADDR å¯„å­˜å™¨
  899   2              // è®¾ç½®ä¸º:0x19 ç£åŠ›è®¡é‡ç¨‹ä¸º:8G     è·å–åˆ°çš„åŠ é€Ÿåº¦è®¡æ•°æ® é™¤ä»¥3000ï¼Œ å¯ä»¥è½
             -¬åŒ–ä¸ºå¸¦ç‰©ç†å•ä½çš„æ•°æ®ï¼Œå•ä½ï¼šG(é«˜æ–¯)
  900   2              // è®¾ç½®ä¸º:0x09 ç£åŠ›è®¡é‡ç¨‹ä¸º:2G     è·å–åˆ°çš„åŠ é€Ÿåº¦è®¡æ•°æ® é™¤ä»¥12000ï¼Œå¯ä»¥è½
             -¬åŒ–ä¸ºå¸¦ç‰©ç†å•ä½çš„æ•°æ®ï¼Œå•ä½ï¼šG(é«˜æ–¯)
  901   2      
  902   2              imu963ra_write_mag_register(IMU963RA_MAG_ADDR, IMU963RA_MAG_FBR, 0x01);
  903   2              imu963ra_connect_mag(IMU963RA_MAG_ADDR, IMU963RA_MAG_OUTX_L);
  904   2      
  905   2              imu963ra_write_acc_gyro_register(IMU963RA_FUNC_CFG_ACCESS, 0x00);       // å…³é—­HUBå¯„å­˜å™¨è®¿é
             -—®
  906   2      
  907   2              delay_ms(20);                                                    // ç­‰å¾…ç£åŠ›è®¡è·å–æ•°æ®
  908   2          } while(0);
  909   1      
  910   1          return return_state;
  911   1      }


Module Information          Static   Overlayable
------------------------------------------------
  code size            =      1777     ------
  ecode size           =    ------     ------
  data size            =    ------     ------
  idata size           =    ------     ------
  pdata size           =    ------     ------
  xdata size           =    ------     ------
  xdata-const size     =    ------     ------
  edata size           =       107     ------
  bit size             =    ------     ------
  ebit size            =    ------     ------
  bitaddressable size  =    ------     ------
  ebitaddressable size =    ------     ------
  far data size        =    ------     ------
  huge data size       =    ------     ------
  const size           =    ------     ------
  hconst size          =       129     ------
End of Module Information.


C251 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
