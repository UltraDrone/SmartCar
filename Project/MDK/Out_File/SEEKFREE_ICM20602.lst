C251 COMPILER V5.60.0,  SEEKFREE_ICM20602                                                  06/07/24  23:05:05  PAGE 1   


C251 COMPILER V5.60.0, COMPILATION OF MODULE SEEKFREE_ICM20602
OBJECT MODULE PLACED IN .\Out_File\SEEKFREE_ICM20602.obj
COMPILER INVOKED BY: G:\Keil_v5\C251\C251\BIN\C251.EXE ..\..\Libraries\seekfree_peripheral\SEEKFREE_ICM20602.c XSMALL IN
                    -TR2 WARNINGLEVEL(3) OPTIMIZE(0,SPEED) BROWSE INCDIR(..\..\Libraries\libraries;..\..\Libraries\seekfree_libraries;..\..\L
                    -ibraries\seekfree_peripheral;..\CODE;..\USER\inc;..\USER\src;..\CODE) DEBUG PRINT(.\Out_File\SEEKFREE_ICM20602.lst) OBJE
                    -CT(.\Out_File\SEEKFREE_ICM20602.obj) 

stmt  level    source

    1          /********************************************************************************************************
             -*************
    2           * COPYRIGHT NOTICE
    3           * Copyright (c) 2018,Öð·É¿Æ¼¼
    4           * All rights reserved.
    5           * ¼¼ÊõÌÖÂÛQQÈº£ºÒ»Èº£º179029047(ÒÑÂú)  ¶þÈº£º244861897
    6           *
    7           * ÒÔÏÂËùÓÐÄÚÈÝ°æÈ¨¾ùÊôÖð·É¿Æ¼¼ËùÓÐ£¬Î´¾­ÔÊÐí²»µÃÓÃÓÚÉÌÒµÓÃÍ¾£¬
    8           * »¶Ó­¸÷Î»Ê¹ÓÃ²¢´«²¥±¾³ÌÐò£¬ÐÞ¸ÄÄÚÈÝÊ±±ØÐë±£ÁôÖð·É¿Æ¼¼µÄ°æÈ¨ÉùÃ÷¡£
    9           *
   10           * @file                ICM20602
   11           * @company                     ³É¶¼Öð·É¿Æ¼¼ÓÐÏÞ¹«Ë¾
   12           * @author              Öð·É¿Æ¼¼(QQ3184284598)
   13           * @version             ²é¿´docÄÚversionÎÄ¼þ °æ±¾ËµÃ÷
   14           * @Software            MDK FOR C251 V5.60
   15           * @Target core         STC32G12K128
   16           * @Taobao              https://seekfree.taobao.com/
   17           * @date                2019-04-30
   18           * @note
   19                                                  ½ÓÏß¶¨Òå£º
   20                                                  ------------------------------------
   21                                                  ICM20602Ä£¿é(SPIÍ¨ÐÅ)   µ¥Æ¬»ú
   22                                                  SPC                             ²é¿´SEEKFREE_ICM20602.hÎÄ¼þÖÐµÄICM20602_SPC_PINºê¶¨Òå
   23                                                  SDI                             ²é¿´SEEKFREE_ICM20602.hÎÄ¼þÖÐµÄICM20602_SDI_PINºê¶¨Òå
   24                                                  SDO                             ²é¿´SEEKFREE_ICM20602.hÎÄ¼þÖÐµÄICM20602_SDO_PINºê¶¨Òå
   25                                                  CS                              ²é¿´SEEKFREE_ICM20602.hÎÄ¼þÖÐµÄICM20602_CS_PINºê¶¨Òå
   26                                                  ------------------------------------
   27                                                  ICM20602Ä£¿é(IICÍ¨ÐÅ)   µ¥Æ¬»ú
   28                                                  SCL                             ²é¿´SEEKFREE_ICM20602.hÎÄ¼þÖÐµÄICM20602_SCL_PINºê¶¨Òå
   29                                                  SDA                             ²é¿´SEEKFREE_ICM20602.hÎÄ¼þÖÐµÄICM20602_SDA_PINºê¶¨Òå
   30                                                  ------------------------------------
   31           ********************************************************************************************************
             -************/
   32          
   33          
   34          #include "SEEKFREE_ICM20602.h"
   35          
   36          #include "zf_delay.h"
   37          #include "zf_spi.h"
   38          
   39          
   40          #pragma warning disable = 177
   41          #pragma warning disable = 183
   42          
   43          int16 icm20602_gyro_x, icm20602_gyro_y, icm20602_gyro_z;
   44          int16 icm20602_acc_x, icm20602_acc_y, icm20602_acc_z;
   45          
   46          
   47          #if ICM20602_USE_SOFT_IIC
               
               
               #define GET_ICM20602_SDA                        ICM20602_SDA_PIN
               #define ICM20602_SDA_LOW()              ICM20602_SDA_PIN = 0            //IO¿ÚÊä³öµÍµçÆ½
               #define ICM20602_SDA_HIGH()         ICM20602_SDA_PIN = 1                //IO¿ÚÊä³ö¸ßµçÆ½
               
               #define ICM20602_SCL_LOW()          ICM20602_SCL_PIN = 0                //IO¿ÚÊä³öµÍµçÆ½
C251 COMPILER V5.60.0,  SEEKFREE_ICM20602                                                  06/07/24  23:05:05  PAGE 2   

               #define ICM20602_SCL_HIGH()         ICM20602_SCL_PIN = 1                //IO¿ÚÊä³ö¸ßµçÆ½
               
               #define ack 1      //Ö÷Ó¦´ð
               #define no_ack 0   //´ÓÓ¦´ð     
               
               //-------------------------------------------------------------------------------------------------------
             -------------
               //  @brief      Ä£ÄâIICÑÓÊ±
               //  @return     void
               //  @since      v1.0
               //  Sample usage:                               Èç¹ûIICÍ¨Ñ¶Ê§°Ü¿ÉÒÔ³¢ÊÔÔö¼ÓjµÄÖµ
               //-------------------------------------------------------------------------------------------------------
             -------------
               static void icm20602_simiic_delay(void)
               {
                   uint16 j = ICM20602_SOFT_IIC_DELAY;
               
                   while(j--);
               }
               
               //ÄÚ²¿Ê¹ÓÃ£¬ÓÃ»§ÎÞÐèµ÷ÓÃ
               static void icm20602_simiic_start(void)
               {
                   ICM20602_SDA_HIGH();
                   ICM20602_SCL_HIGH();
                   icm20602_simiic_delay();
                   ICM20602_SDA_LOW();
                   icm20602_simiic_delay();
                   ICM20602_SCL_LOW();
               }
               
               //ÄÚ²¿Ê¹ÓÃ£¬ÓÃ»§ÎÞÐèµ÷ÓÃ
               static void icm20602_simiic_stop(void)
               {
                   ICM20602_SDA_LOW();
                   ICM20602_SCL_LOW();
                   icm20602_simiic_delay();
                   ICM20602_SCL_HIGH();
                   icm20602_simiic_delay();
                   ICM20602_SDA_HIGH();
                   icm20602_simiic_delay();
               }
               
               //Ö÷Ó¦´ð(°üº¬ack:SDA=0ºÍno_ack:SDA=0)
               //ÄÚ²¿Ê¹ÓÃ£¬ÓÃ»§ÎÞÐèµ÷ÓÃ
               static void icm20602_simiic_sendack(unsigned char ack_dat)
               {
                   ICM20602_SCL_LOW();
                   icm20602_simiic_delay();
               
                   if(ack_dat) ICM20602_SDA_LOW();
                   else        ICM20602_SDA_HIGH();
               
                   ICM20602_SCL_HIGH();
                   icm20602_simiic_delay();
                   ICM20602_SCL_LOW();
                   icm20602_simiic_delay();
               }
               
               
               static int icm20602_sccb_waitack(void)
               {
                   ICM20602_SCL_LOW();
               
                   icm20602_simiic_delay();
               
C251 COMPILER V5.60.0,  SEEKFREE_ICM20602                                                  06/07/24  23:05:05  PAGE 3   

                   ICM20602_SCL_HIGH();
                   icm20602_simiic_delay();
               
                   if(GET_ICM20602_SDA)           //Ó¦´ðÎª¸ßµçÆ½£¬Òì³££¬Í¨ÐÅÊ§°Ü
                   {
               
                       ICM20602_SCL_LOW();
                       return 0;
                   }
               
                   ICM20602_SCL_LOW();
                   icm20602_simiic_delay();
                   return 1;
               }
               
               //×Ö½Ú·¢ËÍ³ÌÐò
               //·¢ËÍc(¿ÉÒÔÊÇÊý¾ÝÒ²¿ÉÊÇµØÖ·)£¬ËÍÍêºó½ÓÊÕ´ÓÓ¦´ð
               //²»¿¼ÂÇ´ÓÓ¦´ðÎ»
               //ÄÚ²¿Ê¹ÓÃ£¬ÓÃ»§ÎÞÐèµ÷ÓÃ
               static void icm20602_send_ch(uint8 c)
               {
                   uint8 i = 8;
               
                   while(i--)
                   {
                       if(c & 0x80)    ICM20602_SDA_HIGH();//SDA Êä³öÊý¾Ý
                       else                    ICM20602_SDA_LOW();
               
                       c <<= 1;
                       icm20602_simiic_delay();
                       ICM20602_SCL_HIGH();                //SCL À­¸ß£¬²É¼¯ÐÅºÅ
                       icm20602_simiic_delay();
                       ICM20602_SCL_LOW();                //SCL Ê±ÖÓÏßÀ­µÍ
                   }
               
                   icm20602_sccb_waitack();
               }
               
               
               //×Ö½Ú½ÓÊÕ³ÌÐò
               //½ÓÊÕÆ÷¼þ´«À´µÄÊý¾Ý£¬´Ë³ÌÐòÓ¦ÅäºÏ|Ö÷Ó¦´ðº¯Êý|Ê¹ÓÃ
               //ÄÚ²¿Ê¹ÓÃ£¬ÓÃ»§ÎÞÐèµ÷ÓÃ
               static uint8 icm20602_read_ch(uint8 ack_x)
               {
                   uint8 i;
                   uint8 c;
                   c = 0;
                   ICM20602_SCL_LOW();
                   icm20602_simiic_delay();
                   ICM20602_SDA_HIGH();
               
                   for(i = 0; i < 8; i++)
                   {
                       icm20602_simiic_delay();
                       ICM20602_SCL_LOW();         //ÖÃÊ±ÖÓÏßÎªµÍ£¬×¼±¸½ÓÊÕÊý¾ÝÎ»
                       icm20602_simiic_delay();
                       ICM20602_SCL_HIGH();         //ÖÃÊ±ÖÓÏßÎª¸ß£¬Ê¹Êý¾ÝÏßÉÏÊý¾ÝÓÐÐ§
                       icm20602_simiic_delay();
                       c <<= 1;
               
                       if(GET_ICM20602_SDA)
                       {
                           c += 1; //¶ÁÊý¾ÝÎ»£¬½«½ÓÊÕµÄÊý¾Ý´æc
                       }
                   }
               
C251 COMPILER V5.60.0,  SEEKFREE_ICM20602                                                  06/07/24  23:05:05  PAGE 4   

                   ICM20602_SCL_LOW();
                   icm20602_simiic_delay();
                   icm20602_simiic_sendack(ack_x);
               
                   return c;
               }
               
               
               //-------------------------------------------------------------------------------------------------------
             -------------
               //  @brief      Ä£ÄâIICÐ´Êý¾Ýµ½Éè±¸¼Ä´æÆ÷º¯Êý
               //  @param      dev_add                 Éè±¸µØÖ·(µÍÆßÎ»µØÖ·)
               //  @param      reg                             ¼Ä´æÆ÷µØÖ·
               //  @param      dat                             Ð´ÈëµÄÊý¾Ý
               //  @return     void
               //  @since      v1.0
               //  Sample usage:
               //-------------------------------------------------------------------------------------------------------
             -------------
               static void icm20602_simiic_write_reg(uint8 dev_add, uint8 reg, uint8 dat)
               {
                   icm20602_simiic_start();
                   icm20602_send_ch( (dev_add << 1) | 0x00); //·¢ËÍÆ÷¼þµØÖ·¼ÓÐ´Î»
                   icm20602_send_ch( reg );                             //·¢ËÍ´Ó»ú¼Ä´æÆ÷µØÖ·
                   icm20602_send_ch( dat );                             //·¢ËÍÐèÒªÐ´ÈëµÄÊý¾Ý
                   icm20602_simiic_stop();
               }
               
               //-------------------------------------------------------------------------------------------------------
             -------------
               //  @brief      Ä£ÄâIIC´ÓÉè±¸¼Ä´æÆ÷¶ÁÈ¡Êý¾Ý
               //  @param      dev_add                 Éè±¸µØÖ·(µÍÆßÎ»µØÖ·)
               //  @param      reg                             ¼Ä´æÆ÷µØÖ·
               //  @param      type                    Ñ¡ÔñÍ¨ÐÅ·½Ê½ÊÇIIC  »¹ÊÇ SCCB
               //  @return     uint8                   ·µ»Ø¼Ä´æÆ÷µÄÊý¾Ý
               //  @since      v1.0
               //  Sample usage:
               //-------------------------------------------------------------------------------------------------------
             -------------
               static uint8 icm20602_simiic_read_reg(uint8 dev_add, uint8 reg)
               {
                   uint8 dat;
                   icm20602_simiic_start();
                   icm20602_send_ch( (dev_add << 1) | 0x00); //·¢ËÍÆ÷¼þµØÖ·¼ÓÐ´Î»
                   icm20602_send_ch( reg );                            //·¢ËÍ´Ó»ú¼Ä´æÆ÷µØÖ·
               
               
                   icm20602_simiic_start();
                   icm20602_send_ch( (dev_add << 1) | 0x01); //·¢ËÍÆ÷¼þµØÖ·¼Ó¶ÁÎ»
                   dat = icm20602_read_ch(no_ack);                             //¶ÁÈ¡Êý¾Ý
                   icm20602_simiic_stop();
               
                   return dat;
               }
               
               //-------------------------------------------------------------------------------------------------------
             -------------
               //  @brief      Ä£ÄâIIC¶ÁÈ¡¶à×Ö½ÚÊý¾Ý
               //  @param      dev_add                 Éè±¸µØÖ·(µÍÆßÎ»µØÖ·)
               //  @param      reg                             ¼Ä´æÆ÷µØÖ·
               //  @param      dat_add                 Êý¾Ý±£´æµÄµØÖ·Ö¸Õë
               //  @param      num                             ¶ÁÈ¡×Ö½ÚÊýÁ¿
               //  @param      type                    Ñ¡ÔñÍ¨ÐÅ·½Ê½ÊÇIIC  »¹ÊÇ SCCB
               //  @return     uint8                   ·µ»Ø¼Ä´æÆ÷µÄÊý¾Ý
               //  @since      v1.0
               //  Sample usage:
C251 COMPILER V5.60.0,  SEEKFREE_ICM20602                                                  06/07/24  23:05:05  PAGE 5   

               //-------------------------------------------------------------------------------------------------------
             -------------
               static void icm20602_simiic_read_regs(uint8 dev_add, uint8 reg, uint8 *dat_add, uint32 num)
               {
                   icm20602_simiic_start();
                   icm20602_send_ch( (dev_add << 1) | 0x00); //·¢ËÍÆ÷¼þµØÖ·¼ÓÐ´Î»
                   icm20602_send_ch( reg );                            //·¢ËÍ´Ó»ú¼Ä´æÆ÷µØÖ·
               
               
                   icm20602_simiic_start();
                   icm20602_send_ch( (dev_add << 1) | 0x01); //·¢ËÍÆ÷¼þµØÖ·¼Ó¶ÁÎ»
               
                   while(--num)
                   {
                       *dat_add = icm20602_read_ch(ack); //¶ÁÈ¡Êý¾Ý
                       dat_add++;
                   }
               
                   *dat_add = icm20602_read_ch(no_ack); //¶ÁÈ¡Êý¾Ý
                   icm20602_simiic_stop();
               }
               
               #define icm20602_write_register(reg, dat)        (icm20602_simiic_write_reg(ICM20602_DEV_ADDR, (reg), (da
             -t)))
               #define icm20602_write_registers(reg, dat, len)  (icm20602_simiic_write_regs(ICM20602_DEV_ADDR, (reg), (d
             -at), (len)))
               #define icm20602_read_register(reg)              (icm20602_simiic_read_reg(ICM20602_DEV_ADDR, (reg)))
               #define icm20602_read_registers(reg, dat, len)   (icm20602_simiic_read_regs(ICM20602_DEV_ADDR, (reg), (da
             -t), (len)))
               
               #else
  273          
  274          #define ICM20602_SCK(x)                         ICM20602_SPC_PIN  = x
  275          #define ICM20602_MOSI(x)                        ICM20602_SDI_PIN = x
  276          #define ICM20602_CS(x)                          ICM20602_CS_PIN  = x
  277          #define ICM20602_MISO                           ICM20602_SDO_PIN
  278          
  279          //-------------------------------------------------------------------------------------------------------
             -------------
  280          //  @brief      Í¨¹ýSPIÐ´Ò»¸öbyte,Í¬Ê±¶ÁÈ¡Ò»¸öbyte
  281          //  @param      byte        ·¢ËÍµÄÊý¾Ý
  282          //  @return     uint8       return ·µ»Østatus×´Ì¬
  283          //  @since      v1.0
  284          //  Sample usage:
  285          //-------------------------------------------------------------------------------------------------------
             -------------
  286          static uint8 icm20602_simspi_wr_byte(uint8 byte)
  287          {
  288   1          uint8 i;
  289   1      
  290   1          for(i = 0; i < 8; i++)
  291   1          {
  292   2              ICM20602_MOSI(byte & 0x80);
  293   2              byte <<= 1;
  294   2              ICM20602_SCK (0);
  295   2              ICM20602_SCK (0);
  296   2      
  297   2              ICM20602_SCK (1);
  298   2              ICM20602_SCK (1);
  299   2              byte |= ICM20602_MISO;
  300   2          }
  301   1      
  302   1          return(byte);
  303   1      }
  304          //-------------------------------------------------------------------------------------------------------
             -------------
C251 COMPILER V5.60.0,  SEEKFREE_ICM20602                                                  06/07/24  23:05:05  PAGE 6   

  305          //  @brief      ½«valÐ´Èëcmd¶ÔÓ¦µÄ¼Ä´æÆ÷µØÖ·,Í¬Ê±·µ»Østatus×Ö½Ú
  306          //  @param      cmd         ÃüÁî×Ö
  307          //  @param      val         ´ýÐ´Èë¼Ä´æÆ÷µÄÊýÖµ
  308          //  @since      v1.0
  309          //  Sample usage:
  310          //-------------------------------------------------------------------------------------------------------
             -------------
  311          static void icm20602_simspi_w_reg_byte(uint8 cmd, uint8 val)
  312          {
  313   1      
  314   1          cmd |= ICM20602_SPI_W;
  315   1          icm20602_simspi_wr_byte(cmd);
  316   1          icm20602_simspi_wr_byte(val);
  317   1      
  318   1      }
  319          
  320          
  321          //-------------------------------------------------------------------------------------------------------
             -------------
  322          //  @brief      ½«valÐ´Èëcmd¶ÔÓ¦µÄ¼Ä´æÆ÷µØÖ·
  323          //  @param      cmd         ÃüÁî×Ö
  324          //  @param      val         ´ýÐ´Èë¼Ä´æÆ÷µÄÊýÖµ
  325          //  @since      v1.0
  326          //  Sample usage:
  327          //-------------------------------------------------------------------------------------------------------
             -------------
  328          //static void icm20602_simspi_w_reg_bytes(uint8 cmd, uint8 *dat_addr, uint32 len)
  329          //{
  330          
  331          //
  332          //    ICM20602_CS(0);
  333          //    cmd |= ICM20602_SPI_W;
  334          //    icm20602_simspi_wr_byte(cmd);
  335          //      while(len--)
  336          //      {
  337          //              icm20602_simspi_wr_byte(*dat_addr++);
  338          //      }
  339          //    ICM20602_CS(1);
  340          //}
  341          
  342          //-------------------------------------------------------------------------------------------------------
             -------------
  343          //  @brief      ¶ÁÈ¡cmdËù¶ÔÓ¦µÄ¼Ä´æÆ÷µØÖ·
  344          //  @param      cmd         ÃüÁî×Ö
  345          //  @param      *val        ´æ´¢¶ÁÈ¡µÄÊý¾ÝµØÖ·
  346          //  @since      v1.0
  347          //  Sample usage:
  348          //-------------------------------------------------------------------------------------------------------
             -------------
  349          static void icm20602_simspi_r_reg_byte(uint8 cmd, uint8 *val)
  350          {
  351   1      
  352   1          cmd |= ICM20602_SPI_R;
  353   1          icm20602_simspi_wr_byte(cmd);
  354   1          *val = icm20602_simspi_wr_byte(0);
  355   1      
  356   1      }
  357          
  358          //-------------------------------------------------------------------------------------------------------
             -------------
  359          //  @brief      ¶ÁÈ¡cmdËù¶ÔÓ¦µÄ¼Ä´æÆ÷µØÖ·
  360          //  @param      cmd         ÃüÁî×Ö
  361          //  @param      *val        ´æ´¢¶ÁÈ¡µÄÊý¾ÝµØÖ·
  362          //  @param      num         ¶ÁÈ¡µÄÊýÁ¿
  363          //  @since      v1.0
  364          //  Sample usage:
C251 COMPILER V5.60.0,  SEEKFREE_ICM20602                                                  06/07/24  23:05:05  PAGE 7   

  365          //-------------------------------------------------------------------------------------------------------
             -------------
  366          static void icm20602_simspi_r_reg_bytes(uint8 cmd, uint8 *val, uint32 num)
  367          {
  368   1          uint32 i = 0;
  369   1          cmd |= ICM20602_SPI_R;
  370   1          icm20602_simspi_wr_byte(cmd);
  371   1      
  372   1          while(num--)
  373   1          {
  374   2              *val++ = icm20602_simspi_wr_byte(0);
  375   2          }
  376   1      }
  377          
  378          
  379          //-------------------------------------------------------------------------------------------------------
             -------------
  380          // º¯Êý¼ò½é     IMU660RA Ð´¼Ä´æÆ÷
  381          // ²ÎÊýËµÃ÷     reg             ¼Ä´æÆ÷µØÖ·
  382          // ²ÎÊýËµÃ÷     dat            Êý¾Ý
  383          // ·µ»Ø²ÎÊý     void
  384          // Ê¹ÓÃÊ¾Àý     icm20602_write_register(ICM20602_PWR_CONF, 0x00);                   // ¹Ø±Õ¸ß¼¶Ê¡µçÄ£Ê½
  385          // ±¸×¢ÐÅÏ¢     ÄÚ²¿µ÷ÓÃ
  386          //-------------------------------------------------------------------------------------------------------
             -------------
  387          static void icm20602_write_register(uint8 reg, uint8 dat)
  388          {
  389   1          ICM20602_CS(0);
  390   1          icm20602_simspi_w_reg_byte(reg | ICM20602_SPI_W, dat);
  391   1          ICM20602_CS(1);
  392   1      }
  393          
  394          //-------------------------------------------------------------------------------------------------------
             -------------
  395          // º¯Êý¼ò½é     IMU660RA Ð´Êý¾Ý
  396          // ²ÎÊýËµÃ÷     reg             ¼Ä´æÆ÷µØÖ·
  397          // ²ÎÊýËµÃ÷     dat            Êý¾Ý
  398          // ·µ»Ø²ÎÊý     void
  399          // Ê¹ÓÃÊ¾Àý     icm20602_write_registers(ICM20602_INIT_dat, icm20602_config_file, sizeof(icm20602_config_
             -file));
  400          // ±¸×¢ÐÅÏ¢     ÄÚ²¿µ÷ÓÃ
  401          //-------------------------------------------------------------------------------------------------------
             -------------
  402          //static void icm20602_write_registers(uint8 reg, const uint8 *dat, uint32 len)
  403          //{
  404          //    ICM20602_CS(0);
  405          //    icm20602_simspi_w_reg_bytes(reg | ICM20602_SPI_W, dat, len);
  406          //    ICM20602_CS(1);
  407          //}
  408          
  409          //-------------------------------------------------------------------------------------------------------
             -------------
  410          // º¯Êý¼ò½é     IMU660RA ¶Á¼Ä´æÆ÷
  411          // ²ÎÊýËµÃ÷     reg             ¼Ä´æÆ÷µØÖ·
  412          // ·µ»Ø²ÎÊý     uint8           Êý¾Ý
  413          // Ê¹ÓÃÊ¾Àý     icm20602_read_register(ICM20602_CHIP_ID);
  414          // ±¸×¢ÐÅÏ¢     ÄÚ²¿µ÷ÓÃ
  415          //-------------------------------------------------------------------------------------------------------
             -------------
  416          static uint8 icm20602_read_register(uint8 reg)
  417          {
  418   1          uint8 dat;
  419   1          ICM20602_CS(0);
  420   1          icm20602_simspi_r_reg_byte(reg | ICM20602_SPI_R, &dat);
  421   1          ICM20602_CS(1);
  422   1          return dat;
C251 COMPILER V5.60.0,  SEEKFREE_ICM20602                                                  06/07/24  23:05:05  PAGE 8   

  423   1      }
  424          
  425          //-------------------------------------------------------------------------------------------------------
             -------------
  426          // º¯Êý¼ò½é     IMU660RA ¶ÁÊý¾Ý
  427          // ²ÎÊýËµÃ÷     reg             ¼Ä´æÆ÷µØÖ·
  428          // ²ÎÊýËµÃ÷     dat            Êý¾Ý»º³åÇø
  429          // ²ÎÊýËµÃ÷     len             Êý¾Ý³¤¶È
  430          // ·µ»Ø²ÎÊý     void
  431          // Ê¹ÓÃÊ¾Àý     icm20602_read_registers(ICM20602_ACC_ADDRESS, dat, 6);
  432          // ±¸×¢ÐÅÏ¢     ÄÚ²¿µ÷ÓÃ
  433          //-------------------------------------------------------------------------------------------------------
             -------------
  434          static void icm20602_read_registers(uint8 reg, uint8 *dat, uint32 len)
  435          {
  436   1          ICM20602_CS(0);
  437   1          icm20602_simspi_r_reg_bytes(reg | ICM20602_SPI_R, dat, len);
  438   1          ICM20602_CS(1);
  439   1      }
  440          
  441          
  442          #endif
  443          
  444          //-------------------------------------------------------------------------------------------------------
             -------------
  445          // º¯Êý¼ò½é     ICM20602 ×Ô¼ì
  446          // ²ÎÊýËµÃ÷     void
  447          // ·µ»Ø²ÎÊý     uint8           1-×Ô¼ìÊ§°Ü 0-×Ô¼ì³É¹¦
  448          // Ê¹ÓÃÊ¾Àý     icm20602_self_check();
  449          // ±¸×¢ÐÅÏ¢     ÄÚ²¿µ÷ÓÃ
  450          //-------------------------------------------------------------------------------------------------------
             -------------
  451          static uint8 icm20602_self_check (void)
  452          {
  453   1          uint8 dat = 0, return_state = 0;
  454   1          uint16 timeout_count = 0;
  455   1      
  456   1          while(0x12 != dat)                                                          // ÅÐ¶Ï ID ÊÇ·ñÕýÈ·
  457   1          {
  458   2              if(timeout_count ++ > ICM20602_TIMEOUT_COUNT)
  459   2              {
  460   3                  return_state =  1;
  461   3                  break;
  462   3              }
  463   2      
  464   2              dat = icm20602_read_register(ICM20602_WHO_AM_I);
  465   2      
  466   2              delay_ms(10);
  467   2          }
  468   1      
  469   1          return return_state;
  470   1      }
  471          
  472          //-------------------------------------------------------------------------------------------------------
             -------------
  473          // º¯Êý¼ò½é     »ñÈ¡ ICM20602 ¼ÓËÙ¶È¼ÆÊý¾Ý
  474          // ²ÎÊýËµÃ÷     void
  475          // ·µ»Ø²ÎÊý     void
  476          // Ê¹ÓÃÊ¾Àý     icm20602_get_acc();                                             // Ö´ÐÐ¸Ãº¯Êýºó£¬Ö±½Ó²é¿´
             -¶ÔÓ¦µÄ±äÁ¿¼´¿É
  477          // ±¸×¢ÐÅÏ¢
  478          //-------------------------------------------------------------------------------------------------------
             -------------
  479          void icm20602_get_acc (void)
  480          {
  481   1          uint8 dat[6];
C251 COMPILER V5.60.0,  SEEKFREE_ICM20602                                                  06/07/24  23:05:05  PAGE 9   

  482   1      
  483   1          icm20602_read_registers(ICM20602_ACCEL_XOUT_H, dat, 6);
  484   1          icm20602_acc_x = (int16)(((uint16)dat[0] << 8 | dat[1]));
  485   1          icm20602_acc_y = (int16)(((uint16)dat[2] << 8 | dat[3]));
  486   1          icm20602_acc_z = (int16)(((uint16)dat[4] << 8 | dat[5]));
  487   1      }
  488          
  489          //-------------------------------------------------------------------------------------------------------
             -------------
  490          // º¯Êý¼ò½é     »ñÈ¡ICM20602ÍÓÂÝÒÇÊý¾Ý
  491          // ²ÎÊýËµÃ÷     void
  492          // ·µ»Ø²ÎÊý     void
  493          // Ê¹ÓÃÊ¾Àý     icm20602_get_gyro();                                            // Ö´ÐÐ¸Ãº¯Êýºó£¬Ö±½Ó²é¿´
             -¶ÔÓ¦µÄ±äÁ¿¼´¿É
  494          // ±¸×¢ÐÅÏ¢
  495          //-------------------------------------------------------------------------------------------------------
             -------------
  496          void icm20602_get_gyro (void)
  497          {
  498   1          uint8 dat[6];
  499   1      
  500   1          icm20602_read_registers(ICM20602_GYRO_XOUT_H, dat, 6);
  501   1          icm20602_gyro_x = (int16)(((uint16)dat[0] << 8 | dat[1]));
  502   1          icm20602_gyro_y = (int16)(((uint16)dat[2] << 8 | dat[3]));
  503   1          icm20602_gyro_z = (int16)(((uint16)dat[4] << 8 | dat[5]));
  504   1      }
  505          
  506          //-------------------------------------------------------------------------------------------------------
             -------------
  507          // º¯Êý¼ò½é     ½« ICM20602 ¼ÓËÙ¶È¼ÆÊý¾Ý×ª»»ÎªÊµ¼ÊÎïÀíÊý¾Ý
  508          // ²ÎÊýËµÃ÷     gyro_value      ÈÎÒâÖáµÄ¼ÓËÙ¶È¼ÆÊý¾Ý
  509          // ·µ»Ø²ÎÊý     void
  510          // Ê¹ÓÃÊ¾Àý     float data = icm20602_acc_transition(icm20602_acc_x);           // µ¥Î»Îª g(m/s^2)
  511          // ±¸×¢ÐÅÏ¢
  512          //-------------------------------------------------------------------------------------------------------
             -------------
  513          float icm20602_acc_transition (int16 acc_value)
  514          {
  515   1          float acc_data = 0;
  516   1      
  517   1          switch(ICM20602_ACC_SAMPLE)
  518   1          {
  519   2              case 0x00:
  520   2                  acc_data = (float)acc_value / 16384;
  521   2                  break;                  // 0x00 ¼ÓËÙ¶È¼ÆÁ¿³ÌÎª:¡À2g     »ñÈ¡µ½µÄ¼ÓËÙ¶È¼ÆÊý¾Ý ³ýÒÔ 16384      
             -¿ÉÒÔ×ª»¯Îª´øÎïÀíµ¥Î»µÄÊý¾Ý£¬µ¥Î»£ºg(m/s^2)
  522   2      
  523   2              case 0x08:
  524   2                  acc_data = (float)acc_value / 8192;
  525   2                  break;                  // 0x08 ¼ÓËÙ¶È¼ÆÁ¿³ÌÎª:¡À4g     »ñÈ¡µ½µÄ¼ÓËÙ¶È¼ÆÊý¾Ý ³ýÒÔ 8192       
             -¿ÉÒÔ×ª»¯Îª´øÎïÀíµ¥Î»µÄÊý¾Ý£¬µ¥Î»£ºg(m/s^2)
  526   2      
  527   2              case 0x10:
  528   2                  acc_data = (float)acc_value / 4096;
  529   2                  break;                  // 0x10 ¼ÓËÙ¶È¼ÆÁ¿³ÌÎª:¡À8g     »ñÈ¡µ½µÄ¼ÓËÙ¶È¼ÆÊý¾Ý ³ýÒÔ 4096       
             -¿ÉÒÔ×ª»¯Îª´øÎïÀíµ¥Î»µÄÊý¾Ý£¬µ¥Î»£ºg(m/s^2)
  530   2      
  531   2              case 0x18:
  532   2                  acc_data = (float)acc_value / 2048;
  533   2                  break;                  // 0x18 ¼ÓËÙ¶È¼ÆÁ¿³ÌÎª:¡À16g    »ñÈ¡µ½µÄ¼ÓËÙ¶È¼ÆÊý¾Ý ³ýÒÔ 2048       
             -¿ÉÒÔ×ª»¯Îª´øÎïÀíµ¥Î»µÄÊý¾Ý£¬µ¥Î»£ºg(m/s^2)
  534   2      
  535   2              default:
  536   2                  break;
  537   2          }
  538   1      
C251 COMPILER V5.60.0,  SEEKFREE_ICM20602                                                  06/07/24  23:05:05  PAGE 10  

  539   1          return acc_data;
  540   1      }
  541          
  542          //-------------------------------------------------------------------------------------------------------
             -------------
  543          // º¯Êý¼ò½é     ½« ICM20602 ÍÓÂÝÒÇÊý¾Ý×ª»»ÎªÊµ¼ÊÎïÀíÊý¾Ý
  544          // ²ÎÊýËµÃ÷     gyro_value      ÈÎÒâÖáµÄÍÓÂÝÒÇÊý¾Ý
  545          // ·µ»Ø²ÎÊý     void
  546          // Ê¹ÓÃÊ¾Àý     float data = icm20602_gyro_transition(icm20602_gyro_x);         // µ¥Î»Îª¡ã/s
  547          // ±¸×¢ÐÅÏ¢
  548          //-------------------------------------------------------------------------------------------------------
             -------------
  549          float icm20602_gyro_transition (int16 gyro_value)
  550          {
  551   1          float gyro_data = 0;
  552   1      
  553   1          switch(ICM20602_GYR_SAMPLE)
  554   1          {
  555   2              case 0x00:
  556   2                  gyro_data = (float)gyro_value / 131.0f;
  557   2                  break;              // 0x00 ÍÓÂÝÒÇÁ¿³ÌÎª:¡À250 dps     »ñÈ¡µ½µÄÍÓÂÝÒÇÊý¾Ý³ýÒÔ 131           ¿
             -ÉÒÔ×ª»¯Îª´øÎïÀíµ¥Î»µÄÊý¾Ý£¬µ¥Î»Îª£º¡ã/s
  558   2      
  559   2              case 0x08:
  560   2                  gyro_data = (float)gyro_value / 65.5f;
  561   2                  break;              // 0x08 ÍÓÂÝÒÇÁ¿³ÌÎª:¡À500 dps     »ñÈ¡µ½µÄÍÓÂÝÒÇÊý¾Ý³ýÒÔ 65.5          ¿
             -ÉÒÔ×ª»¯Îª´øÎïÀíµ¥Î»µÄÊý¾Ý£¬µ¥Î»Îª£º¡ã/s
  562   2      
  563   2              case 0x10:
  564   2                  gyro_data = (float)gyro_value / 32.8f;
  565   2                  break;              // 0x10 ÍÓÂÝÒÇÁ¿³ÌÎª:¡À1000dps     »ñÈ¡µ½µÄÍÓÂÝÒÇÊý¾Ý³ýÒÔ 32.8          ¿
             -ÉÒÔ×ª»¯Îª´øÎïÀíµ¥Î»µÄÊý¾Ý£¬µ¥Î»Îª£º¡ã/s
  566   2      
  567   2              case 0x18:
  568   2                  gyro_data = (float)gyro_value / 16.4f;
  569   2                  break;              // 0x18 ÍÓÂÝÒÇÁ¿³ÌÎª:¡À2000dps     »ñÈ¡µ½µÄÍÓÂÝÒÇÊý¾Ý³ýÒÔ 16.4          ¿
             -ÉÒÔ×ª»¯Îª´øÎïÀíµ¥Î»µÄÊý¾Ý£¬µ¥Î»Îª£º¡ã/s
  570   2      
  571   2              default:
  572   2                  break;
  573   2          }
  574   1      
  575   1          return gyro_data;
  576   1      }
  577          
  578          //-------------------------------------------------------------------------------------------------------
             -------------
  579          // º¯Êý¼ò½é     ³õÊ¼»¯ ICM20602
  580          // ²ÎÊýËµÃ÷     void
  581          // ·µ»Ø²ÎÊý     uint8           1-³õÊ¼»¯Ê§°Ü 0-³õÊ¼»¯³É¹¦
  582          // Ê¹ÓÃÊ¾Àý     icm20602_init();
  583          // ±¸×¢ÐÅÏ¢
  584          //-------------------------------------------------------------------------------------------------------
             -------------
  585          uint8 icm20602_init (void)
  586          {
  587   1          uint8 val = 0x0, return_state = 0;
  588   1          uint16 timeout_count = 0;
  589   1      
  590   1          delay_ms(10);                                                        // ÉÏµçÑÓÊ±
  591   1      
  592   1      //#if ICM20602_USE_SOFT_IIC
  593   1      //    soft_iic_init(&icm20602_iic_struct, ICM20602_DEV_ADDR, ICM20602_SOFT_IIC_DELAY, ICM20602_SCL_PIN, I
             -CM20602_SDA_PIN);
  594   1      //#else
  595   1      //    spi_init(ICM20602_SPI, SPI_MODE0, ICM20602_SPI_SPEED, ICM20602_SPC_PIN, ICM20602_SDI_PIN, ICM20602_
C251 COMPILER V5.60.0,  SEEKFREE_ICM20602                                                  06/07/24  23:05:05  PAGE 11  

             -SDO_PIN, SPI_CS_NULL);
  596   1      //    gpio_init(ICM20602_CS_PIN, GPO, GPIO_HIGH, GPO_PUSH_PULL);
  597   1      //#endif
  598   1      
  599   1          do
  600   1          {
  601   2              if(icm20602_self_check())
  602   2              {
  603   3                  // Èç¹û³ÌÐòÔÚÊä³öÁË¶ÏÑÔÐÅÏ¢ ²¢ÇÒÌáÊ¾³ö´íÎ»ÖÃÔÚÕâÀï
  604   3                  // ÄÇÃ´¾ÍÊÇ ICM20602 ×Ô¼ì³ö´í²¢³¬Ê±ÍË³öÁË
  605   3                  // ¼ì²éÒ»ÏÂ½ÓÏßÓÐÃ»ÓÐÎÊÌâ Èç¹ûÃ»ÎÊÌâ¿ÉÄÜ¾ÍÊÇ»µÁË
  606   3      
  607   3      //                      while(1)
  608   3      //                      {
  609   3                  printf("icm20602 self check error.");
  610   3      //                              delay_ms(200);
  611   3      //                      }
  612   3                  return_state = 1;
  613   3                  break;
  614   3              }
  615   2      
  616   2              icm20602_write_register(ICM20602_PWR_MGMT_1, 0x80);                     // ¸´Î»Éè±¸
  617   2              delay_ms(2);
  618   2      
  619   2              do
  620   2              {   // µÈ´ý¸´Î»³É¹¦
  621   3                  val = icm20602_read_register(ICM20602_PWR_MGMT_1);
  622   3      
  623   3                  if(timeout_count ++ > ICM20602_TIMEOUT_COUNT)
  624   3                  {
  625   4                      // Èç¹û³ÌÐòÔÚÊä³öÁË¶ÏÑÔÐÅÏ¢ ²¢ÇÒÌáÊ¾³ö´íÎ»ÖÃÔÚÕâÀï
  626   4                      // ÄÇÃ´¾ÍÊÇ ICM20602 ×Ô¼ì³ö´í²¢³¬Ê±ÍË³öÁË
  627   4                      // ¼ì²éÒ»ÏÂ½ÓÏßÓÐÃ»ÓÐÎÊÌâ Èç¹ûÃ»ÎÊÌâ¿ÉÄÜ¾ÍÊÇ»µÁË
  628   4      //                              while(1)
  629   4      //                              {
  630   4                      printf("icm20602 reset error.\r\n");
  631   4      //                                      delay_ms(200);
  632   4      //                              }
  633   4                      return_state = 1;
  634   4                      break;
  635   4                  }
  636   3              } while(0x41 != val);
  637   2      
  638   2              if(1 == return_state)
  639   2              {
  640   3                  break;
  641   3              }
  642   2      
  643   2              icm20602_write_register(ICM20602_PWR_MGMT_1,     0x01);                 // Ê±ÖÓÉèÖÃ
  644   2              icm20602_write_register(ICM20602_PWR_MGMT_2,     0x00);                 // ¿ªÆôÍÓÂÝÒÇºÍ¼ÓËÙ¶È¼Æ
  645   2              icm20602_write_register(ICM20602_CONFIG,         0x01);                 // 176HZ 1KHZ
  646   2              icm20602_write_register(ICM20602_SMPLRT_DIV,     0x07);                 // ²ÉÑùËÙÂÊ SAMPLE_RATE =
             - INTERNAL_SAMPLE_RATE / (1 + SMPLRT_DIV)
  647   2      
  648   2              icm20602_write_register(ICM20602_GYRO_CONFIG,    ICM20602_GYR_SAMPLE);  // ¡À2000 dps
  649   2              // ICM20602_GYRO_CONFIG¼Ä´æÆ÷
  650   2              // ÉèÖÃÎª:0x00 ÍÓÂÝÒÇÁ¿³ÌÎª:¡À250 dps     »ñÈ¡µ½µÄÍÓÂÝÒÇÊý¾Ý³ýÒÔ131           ¿ÉÒÔ×ª»¯Îª´øÎïÀíµ¥Î
             -»µÄÊý¾Ý£¬µ¥Î»Îª£º¡ã/s
  651   2              // ÉèÖÃÎª:0x08 ÍÓÂÝÒÇÁ¿³ÌÎª:¡À500 dps     »ñÈ¡µ½µÄÍÓÂÝÒÇÊý¾Ý³ýÒÔ65.5          ¿ÉÒÔ×ª»¯Îª´øÎïÀíµ¥Î
             -»µÄÊý¾Ý£¬µ¥Î»Îª£º¡ã/s
  652   2              // ÉèÖÃÎª:0x10 ÍÓÂÝÒÇÁ¿³ÌÎª:¡À1000dps     »ñÈ¡µ½µÄÍÓÂÝÒÇÊý¾Ý³ýÒÔ32.8          ¿ÉÒÔ×ª»¯Îª´øÎïÀíµ¥Î
             -»µÄÊý¾Ý£¬µ¥Î»Îª£º¡ã/s
  653   2              // ÉèÖÃÎª:0x18 ÍÓÂÝÒÇÁ¿³ÌÎª:¡À2000dps     »ñÈ¡µ½µÄÍÓÂÝÒÇÊý¾Ý³ýÒÔ16.4          ¿ÉÒÔ×ª»¯Îª´øÎïÀíµ¥Î
             -»µÄÊý¾Ý£¬µ¥Î»Îª£º¡ã/s
  654   2      
  655   2              icm20602_write_register(ICM20602_ACCEL_CONFIG,   ICM20602_ACC_SAMPLE);  // ¡À8g
C251 COMPILER V5.60.0,  SEEKFREE_ICM20602                                                  06/07/24  23:05:05  PAGE 12  

  656   2              // ICM20602_ACCEL_CONFIG¼Ä´æÆ÷
  657   2              // ÉèÖÃÎª:0x00 ¼ÓËÙ¶È¼ÆÁ¿³ÌÎª:¡À2g          »ñÈ¡µ½µÄ¼ÓËÙ¶È¼ÆÊý¾Ý ³ýÒÔ16384      ¿ÉÒÔ×ª»¯Îª´øÎïÀíµ
             -¥Î»µÄÊý¾Ý£¬µ¥Î»£ºg(m/s^2)
  658   2              // ÉèÖÃÎª:0x08 ¼ÓËÙ¶È¼ÆÁ¿³ÌÎª:¡À4g          »ñÈ¡µ½µÄ¼ÓËÙ¶È¼ÆÊý¾Ý ³ýÒÔ8192       ¿ÉÒÔ×ª»¯Îª´øÎïÀíµ
             -¥Î»µÄÊý¾Ý£¬µ¥Î»£ºg(m/s^2)
  659   2              // ÉèÖÃÎª:0x10 ¼ÓËÙ¶È¼ÆÁ¿³ÌÎª:¡À8g          »ñÈ¡µ½µÄ¼ÓËÙ¶È¼ÆÊý¾Ý ³ýÒÔ4096       ¿ÉÒÔ×ª»¯Îª´øÎïÀíµ
             -¥Î»µÄÊý¾Ý£¬µ¥Î»£ºg(m/s^2)
  660   2              // ÉèÖÃÎª:0x18 ¼ÓËÙ¶È¼ÆÁ¿³ÌÎª:¡À16g         »ñÈ¡µ½µÄ¼ÓËÙ¶È¼ÆÊý¾Ý ³ýÒÔ2048       ¿ÉÒÔ×ª»¯Îª´øÎïÀíµ
             -¥Î»µÄÊý¾Ý£¬µ¥Î»£ºg(m/s^2)
  661   2      
  662   2              icm20602_write_register(ICM20602_ACCEL_CONFIG_2, 0x03);                 // Average 4 samples   44
             -.8HZ   //0x23 Average 16 samples
  663   2      
  664   2      
  665   2          } while(0);
  666   1      
  667   1          return return_state;
  668   1      }
  669          


Module Information          Static   Overlayable
------------------------------------------------
  code size            =      1040     ------
  ecode size           =    ------     ------
  data size            =    ------     ------
  idata size           =    ------     ------
  pdata size           =    ------     ------
  xdata size           =    ------     ------
  xdata-const size     =    ------     ------
  edata size           =        79     ------
  bit size             =    ------     ------
  ebit size            =    ------     ------
  bitaddressable size  =    ------     ------
  ebitaddressable size =    ------     ------
  far data size        =    ------     ------
  huge data size       =    ------     ------
  const size           =    ------     ------
  hconst size          =        51     ------
End of Module Information.


C251 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
